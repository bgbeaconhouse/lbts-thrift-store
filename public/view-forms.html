<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>View Customer Forms - LBTS</title>
  <script src="/storage-fallback.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header h1 {
      color: #333;
      font-size: 24px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab {
      padding: 12px 24px;
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
    }

    .tab.active {
      background: white;
      color: #667eea;
    }

    .search-box {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .search-box input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }

    .forms-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .form-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .form-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    .form-card h3 {
      color: #333;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .form-card .info {
      color: #666;
      font-size: 14px;
      margin: 5px 0;
    }

    .form-card .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-top: 10px;
    }

    .status.sent {
      background: #d4edda;
      color: #155724;
    }

    .status.pending {
      background: #fff3cd;
      color: #856404;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      overflow-y: auto;
    }

    .modal-content {
      background: white;
      max-width: 800px;
      margin: 50px auto;
      padding: 30px;
      border-radius: 10px;
      position: relative;
    }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }

    .close-btn:hover {
      color: #333;
    }

    .form-details h2 {
      color: #333;
      margin-bottom: 20px;
    }

    .detail-row {
      margin: 15px 0;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }

    .detail-row label {
      font-weight: bold;
      color: #666;
      display: block;
      margin-bottom: 5px;
    }

    .detail-row .value {
      color: #333;
    }

    .signature-container {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 5px;
    }

    .signature-container h3 {
      margin-bottom: 10px;
      color: #333;
    }

    .signature-container img {
      max-width: 100%;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .message {
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      text-align: center;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
    }

    .no-forms {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìã View Customer Forms</h1>
      <button class="btn btn-primary" onclick="window.location.href='/dashboard.html'">
        ‚Üê Back to Dashboard
      </button>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('pickup')">Pick-Up Forms</button>
      <button class="tab" onclick="switchTab('delivery')">Delivery Forms</button>
      <button class="tab" onclick="switchTab('donation')">Donation Forms</button>
      <button class="tab" onclick="switchTab('waiver')">Waiver Forms</button>
    </div>

    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search by customer name, phone, or email..." oninput="filterForms()">
    </div>

    <div id="formsContainer" class="forms-grid"></div>
  </div>

  <!-- Modal for viewing form details -->
  <div id="formModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <div id="formDetails" class="form-details"></div>
    </div>
  </div>

  <script>
    let currentType = 'pickup';
    let allForms = [];

    // Load forms on page load
    window.onload = () => {
      checkAuth();
      loadForms();
    };

    function checkAuth() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/';
        return;
      }
    }

    async function switchTab(type) {
      currentType = type;
      
      // Update active tab
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');

      await loadForms();
    }

    async function loadForms() {
      const token = localStorage.getItem('token');
      const container = document.getElementById('formsContainer');

      try {
        const response = await fetch(`/api/view-forms/${currentType}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const data = await response.json();

        if (response.ok) {
          allForms = data.forms;
          displayForms(allForms);
        } else {
          container.innerHTML = `<div class="message error">${data.error}</div>`;
        }
      } catch (error) {
        console.error('Load forms error:', error);
        container.innerHTML = `<div class="message error">Failed to load forms</div>`;
      }
    }

    function displayForms(forms) {
      const container = document.getElementById('formsContainer');

      if (forms.length === 0) {
        container.innerHTML = `<div class="no-forms">No ${currentType} forms found</div>`;
        return;
      }

      container.innerHTML = forms.map(form => `
        <div class="form-card" onclick="viewFormDetails(${form.id})">
          <h3>${form.customer_name}</h3>
          <div class="info">üìû ${form.phone}</div>
          <div class="info">üìß ${form.email || 'No email'}</div>
          <div class="info">üìÖ ${new Date(form.date).toLocaleDateString()}</div>
          ${form.description ? `<div class="info">üìù ${form.description.substring(0, 50)}${form.description.length > 50 ? '...' : ''}</div>` : ''}
          <span class="status ${form.emailed ? 'sent' : 'pending'}">
            ${form.emailed ? '‚úì Email Sent' : '‚è≥ Email Pending'}
          </span>
        </div>
      `).join('');
    }

    function filterForms() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const filtered = allForms.filter(form => 
        form.customer_name.toLowerCase().includes(searchTerm) ||
        form.phone.toLowerCase().includes(searchTerm) ||
        (form.email && form.email.toLowerCase().includes(searchTerm))
      );
      displayForms(filtered);
    }

    async function viewFormDetails(formId) {
      const token = localStorage.getItem('token');
      const modal = document.getElementById('formModal');
      const detailsContainer = document.getElementById('formDetails');

      try {
        const response = await fetch(`/api/view-forms/${currentType}/${formId}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const data = await response.json();

        if (response.ok) {
          const form = data.form;
          
          detailsContainer.innerHTML = `
            <h2>${currentType.charAt(0).toUpperCase() + currentType.slice(1)} Form Details</h2>
            
            <div class="detail-row">
              <label>Customer Name:</label>
              <div class="value">${form.customer_name}</div>
            </div>

            <div class="detail-row">
              <label>Phone:</label>
              <div class="value">${form.phone}</div>
            </div>

            <div class="detail-row">
              <label>Email:</label>
              <div class="value">${form.email || 'Not provided'}</div>
            </div>

            <div class="detail-row">
              <label>Date:</label>
              <div class="value">${new Date(form.date).toLocaleDateString()}</div>
            </div>

            ${form.items_description || form.donation_description ? `
              <div class="detail-row">
                <label>${currentType === 'donation' ? 'Donation Description' : 'Items Description'}:</label>
                <div class="value">${form.items_description || form.donation_description}</div>
              </div>
            ` : ''}

            ${form.delivery_cost ? `
              <div class="detail-row">
                <label>Delivery Cost:</label>
                <div class="value">$${form.delivery_cost}</div>
              </div>
            ` : ''}

            ${form.delivery_date ? `
              <div class="detail-row">
                <label>Delivery Date:</label>
                <div class="value">${form.delivery_date}</div>
              </div>
            ` : ''}

            <div class="detail-row">
              <label>Email Status:</label>
              <div class="value">
                <span class="status ${form.emailed ? 'sent' : 'pending'}">
                  ${form.emailed ? '‚úì Email Sent' : '‚è≥ Email Pending'}
                </span>
              </div>
            </div>

            ${form.signature_url ? `
              <div class="signature-container">
                <h3>Customer Signature:</h3>
                <img src="${form.signature_url}" alt="Customer Signature">
              </div>
            ` : ''}

            ${form.manager_signature_url ? `
              <div class="signature-container">
                <h3>Manager Signature:</h3>
                <img src="${form.manager_signature_url}" alt="Manager Signature">
              </div>
            ` : ''}

            <div class="detail-row">
              <label>Submitted:</label>
              <div class="value">${new Date(form.created_at).toLocaleString()}</div>
            </div>
          `;

          modal.style.display = 'block';
        } else {
          alert(data.error);
        }
      } catch (error) {
        console.error('View form details error:', error);
        alert('Failed to load form details');
      }
    }

    function closeModal() {
      document.getElementById('formModal').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = (event) => {
      const modal = document.getElementById('formModal');
      if (event.target === modal) {
        closeModal();
      }
    };
  </script>
</body>
</html>