<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LBTS - Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-badge {
      background: rgba(255,255,255,0.2);
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 14px;
    }

    .logout-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    /* Navigation Grid */
    .nav-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .nav-card {
      background: white;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      color: inherit;
      display: block;
    }

    .nav-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }

    .nav-card-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .nav-card h3 {
      color: #2d3748;
      font-size: 20px;
      margin-bottom: 10px;
    }

    .nav-card p {
      color: #718096;
      font-size: 14px;
      line-height: 1.5;
    }

    /* Role Badge */
    .role-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }

    .role-admin { background: #667eea; color: white; }
    .role-manager { background: #48bb78; color: white; }
    .role-employee { background: #ed8936; color: white; }

    /* Welcome Section */
    .welcome {
      background: white;
      border-radius: 10px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .welcome h2 {
      color: #2d3748;
      margin-bottom: 10px;
    }

    .welcome p {
      color: #718096;
      line-height: 1.6;
    }

    /* Alert Permissions Display */
    .alert-permissions {
      margin-top: 15px;
      padding: 15px;
      background: #f7fafc;
      border-radius: 5px;
      border-left: 4px solid #667eea;
    }

    .alert-permissions h4 {
      color: #2d3748;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .alert-badge {
      display: inline-block;
      padding: 4px 10px;
      margin: 4px;
      background: #e6fffa;
      color: #234e52;
      border-radius: 4px;
      font-size: 13px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 10px;
      }

      .nav-grid {
        grid-template-columns: 1fr;
      }
    }

 
/* Unread badge styling */
.unread-badge {
  position: absolute;
  top: -10px;
  right: -10px;
  background-color: #dc3545;
  color: white;
  border-radius: 50%;
  padding: 8px;
  font-size: 16px;
  font-weight: bold;
  min-width: 35px;
  min-height: 35px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
}

.nav-card {
  position: relative;
}
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <h1>üè™ Beacon House Thrift Shop - Long Beach</h1>
      <div class="header-right">
        <div class="user-badge" id="userDisplay">
          <span id="userName"></span>
          <span class="role-badge" id="userRole"></span>
        </div>
        <button class="logout-btn" onclick="handleLogout()">Logout</button>
      </div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">
    <!-- Welcome Section -->
    <div class="welcome">
      <h2 id="welcomeMessage">Welcome!</h2>
      <p>Select a feature below to get started with inventory management, customer forms, or communication.</p>
      <div id="alertPermissions" class="alert-permissions" style="display: none;">
        <h4>üîî Your Alert Permissions:</h4>
        <div id="alertBadges"></div>
      </div>
    </div>

    <!-- Navigation Grid -->
    <div class="nav-grid" id="navGrid">
      <!-- Navigation items will be dynamically added here based on role -->
    </div>
  </div>

  <script>
    let currentUser = null;

    // Check authentication on load
    window.onload = function() {
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user') || 'null');

      if (!token || !user) {
        window.location.href = '/';
        return;
      }

      currentUser = user;
      displayUserInfo();
      buildNavigation();
    };

    function displayUserInfo() {
      document.getElementById('userName').textContent = currentUser.username;
      document.getElementById('welcomeMessage').textContent = `Welcome back, ${currentUser.username}!`;
      
      // Display role badge
      const roleBadge = document.getElementById('userRole');
      roleBadge.textContent = currentUser.role;
      
      if (currentUser.role === 'Admin') {
        roleBadge.className = 'role-badge role-admin';
      } else if (currentUser.role.includes('Manager')) {
        roleBadge.className = 'role-badge role-manager';
      } else {
        roleBadge.className = 'role-badge role-employee';
      }

      // Display alert permissions if any
      const hasAlerts = currentUser.furniture_alerts || currentUser.clothing_alerts || currentUser.bricabrac_alerts;
      
      if (hasAlerts) {
        const alertDiv = document.getElementById('alertPermissions');
        const badgesDiv = document.getElementById('alertBadges');
        alertDiv.style.display = 'block';
        
        let badges = [];
        if (currentUser.furniture_alerts) badges.push('<span class="alert-badge">ü™ë Furniture Alerts</span>');
        if (currentUser.clothing_alerts) badges.push('<span class="alert-badge">üëî Clothing Alerts</span>');
        if (currentUser.bricabrac_alerts) badges.push('<span class="alert-badge">üé® Bric-a-Brac Alerts</span>');
        
        badgesDiv.innerHTML = badges.join('');
      }
    }

    function buildNavigation() {
      const navGrid = document.getElementById('navGrid');
      const navItems = [];

      // Everyone gets these features
      navItems.push({
        icon: 'üè∑Ô∏è',
        title: 'Exclusive Items',
        description: 'Manage red tag inventory with automatic pricing alerts',
        link: '/exclusive-items.html'
      });

      navItems.push({
        icon: 'üí∞',
        title: '75% Off Section',
        description: 'Manage discounted inventory items',
        link: '/discount-items.html'
      });

      navItems.push({
        icon: 'üìã',
        title: 'Customer Forms',
        description: 'Pick-up, delivery, and donation forms',
        link: '/forms.html'
      });

      navItems.push({
        icon: 'üì¶',
        title: 'Pick Up & Delivery Log',
        description: 'Track items awaiting pickup or delivery',
        link: '/inventory-log.html'
      });

// Manager and above get Communication Log
if (currentUser.role !== 'Employee') {
  navItems.push({
    icon: 'üí¨',
    title: 'Communication Log',
    description: 'Important notes and announcements for staff',
    link: '/communication.html',
    id: 'communication-card' // Add ID for badge placement
  });
}

      // Admin only features
      if (currentUser.role === 'Admin') {
        navItems.push({
          icon: 'üìß',
          title: 'Send Emails',
          description: 'Send queued customer form emails',
          link: '/send-emails.html'
        });

        navItems.push({
          icon: 'üë•',
          title: 'User Management',
          description: 'Create and manage user accounts',
          link: '/admin.html'
        });

        navItems.push({
          icon: '‚öôÔ∏è',
          title: 'Settings',
          description: 'System configuration and preferences',
          link: '/settings.html'
        });
      }

      // Build navigation cards
   navGrid.innerHTML = navItems.map(item => `
  <a href="${item.link}" class="nav-card" ${item.id ? `id="${item.id}"` : ''}>
    <div class="nav-card-icon">${item.icon}</div>
    <h3>${item.title}${item.id === 'communication-card' ? '<span id="unreadBadge" class="unread-badge" style="display: none;">0</span>' : ''}</h3>
    <p>${item.description}</p>
  </a>
`).join('');

// Update unread count if Communication Log is visible
if (currentUser.role !== 'Employee') {
  updateUnreadCount();
}

    }

    function handleLogout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/';
      }
    }

    // Function to update unread count badge
async function updateUnreadCount() {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('/api/communication/unread-count', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    if (response.ok) {
      const data = await response.json();
      const badge = document.getElementById('unreadBadge');
      
      if (badge) {
        if (data.unread_count > 0) {
          badge.textContent = data.unread_count;
          badge.style.display = 'inline-block';
        } else {
          badge.style.display = 'none';
        }
      }
    }
  } catch (error) {
    console.error('Error fetching unread count:', error);
  }
}

// Update unread count every 30 seconds
setInterval(() => {
  if (currentUser && currentUser.role !== 'Employee') {
    updateUnreadCount();
  }
}, 30000);
  </script>
</body>
</html>