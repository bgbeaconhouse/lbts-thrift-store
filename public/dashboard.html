<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/css/urgent-alerts.css">
  <title>LBTS - Dashboard</title>
 <script src="/js/fully-touch-fix.js"></script>
  <script src="/js/idle-break-logger.js"></script>
   <script src="/storage-fallback.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }

    /* Header */
 .header {
  background: linear-gradient(135deg, #00a0e0 0%, #1a2f5c 100%);
  color: white;
  padding: 20px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

 .header h1 {
  font-size: 24px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.header-logo {
  width: 60px;
  height: 60px;
  object-fit: contain;
}

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-badge {
      background: rgba(255,255,255,0.2);
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 14px;
    }

    .logout-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    /* Navigation Grid */
    .nav-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .nav-card {
      background: white;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      color: inherit;
      display: block;
    }

    .nav-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }

    .nav-card-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .nav-card h3 {
      color: #2d3748;
      font-size: 20px;
      margin-bottom: 10px;
    }

    .nav-card p {
      color: #718096;
      font-size: 14px;
      line-height: 1.5;
    }

    /* Role Badge */
    .role-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .role-admin { background: #00a0e0; color: white; }
    .role-manager { background: #48bb78; color: white; }
    .role-employee { background: #ed8936; color: white; }

    /* Welcome Section */
    .welcome {
      background: white;
      border-radius: 10px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .welcome h2 {
      color: #2d3748;
      margin-bottom: 10px;
    }

    .welcome p {
      color: #718096;
      line-height: 1.6;
    }

    /* Alert Permissions Display */
    .alert-permissions {
      margin-top: 15px;
      padding: 15px;
      background: #f7fafc;
      border-radius: 5px;
      border-left: 4px solid #00a0e0;
    }

    .alert-permissions h4 {
      color: #2d3748;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .alert-badge {
      display: inline-block;
      padding: 4px 10px;
      margin: 4px;
      background: #e6fffa;
      color: #234e52;
      border-radius: 4px;
      font-size: 13px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 10px;
      }

      .nav-grid {
        grid-template-columns: 1fr;
      }
    }

 
/* Unread badge styling */
.unread-badge {
  position: absolute;
  top: -10px;
  right: -10px;
  background-color: #dc3545;
  color: white;
  border-radius: 50%;
  padding: 8px;
  font-size: 16px;
  font-weight: bold;
  min-width: 35px;
  min-height: 35px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
}

.nav-card {
  position: relative;
}
  </style>
</head>
<body>

  <div id="urgentNoteAlert" class="urgent-alert-overlay" style="display: none;">
  <div class="urgent-alert-modal">
    <div class="urgent-alert-header">
      <h2>‚ö†Ô∏è URGENT NOTICE</h2>
    </div>
    <div class="urgent-alert-body">
      <p id="urgentNoteContent"></p>
      <p class="urgent-note-meta">
        <strong>From:</strong> <span id="urgentNoteAuthor"></span><br>
        <strong>Posted:</strong> <span id="urgentNoteTime"></span>
      </p>
    </div>
    <button id="dismissUrgentNote" class="urgent-dismiss-btn">
      I Understand - Dismiss
    </button>
  </div>
</div>
  <!-- Header -->
  <div class="header">
    <div class="header-content">
    <h1><img src="/images/BeaconLogoNoText.png" alt="Beacon House Logo" class="header-logo"> Thrift Shift</h1>
      <div class="header-right">
        <div class="user-badge" id="userDisplay">
          <span id="userName"></span>
          <span class="role-badge" id="userRole"></span>
        </div>
        <button class="logout-btn" onclick="handleLogout()">Logout</button>
      </div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">
    <!-- Navigation Grid -->
    <div class="nav-grid" id="navGrid">
      <!-- Navigation items will be dynamically added here based on role -->
    </div>
  </div>

  <script>
    let currentUser = null;

    // Check authentication on load
    window.onload = function() {
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user') || 'null');

      if (!token || !user) {
        window.location.href = '/';
        return;
      }

      currentUser = user;
      displayUserInfo();
      buildNavigation();
    };

    function displayUserInfo() {
  // Display role badge
  const roleBadge = document.getElementById('userRole');
  
  // Display "Associate" instead of "Employee"
  let displayRole = currentUser.role;
  if (displayRole === 'Employee') {
    displayRole = 'Associate';
  }
  
  roleBadge.textContent = displayRole;
  
  if (currentUser.role === 'Admin') {
    roleBadge.className = 'role-badge role-admin';
  } else if (currentUser.role.includes('Manager')) {
    roleBadge.className = 'role-badge role-manager';
  } else {
    roleBadge.className = 'role-badge role-employee';
  }
}

    function buildNavigation() {
      const navGrid = document.getElementById('navGrid');
      const navItems = [];

      // Everyone gets these features
      navItems.push({
        icon: 'üè∑Ô∏è',
        title: 'Exclusive Items',
        description: 'Manage red tag inventory with automatic pricing alerts',
        link: '/exclusive-items.html'
      });

      navItems.push({
        icon: 'ü™ë',
        title: 'Furniture Approvals',
        description: 'Review and approve furniture items',
        link: '/discount-items.html'
      });

 navItems.push({
  icon: 'üìã',
  title: 'Customer Forms',
  description: 'Create and manage all customer forms',
  link: '/customer-forms-unified.html'
});

// Communication Log - Available to all users
navItems.push({
  icon: 'üí¨',
  title: 'Communication Log',
  description: 'Important notes and announcements for staff',
  link: '/communication.html',
  id: 'communication-card'
});

// SOPs - Available to all users
navItems.push({
  icon: 'üìö',
  title: 'SOPs',
  description: 'Standard Operating Procedures',
  link: '/sops.html'
});

// Closing Checklist - Available to all users
navItems.push({
  icon: '‚úÖ',
  title: 'Closing Checklist',
  description: 'Daily closing duties checklist',
  link: '/checklist.html'
});

// Banned List - Available to all users
navItems.push({
  icon: 'üö´',
  title: 'Banned List',
  description: 'Manage banned individuals list',
  link: '/banned-list.html'
});

// Vouchers - Available to all users
navItems.push({
  icon: 'üéüÔ∏è',
  title: 'Vouchers',
  description: 'Track customer voucher usage',
  link: '/vouchers.html'
});

// Daily Report - Manager/Admin only
if (currentUser.role === 'Manager' || currentUser.role === 'Admin') {
  navItems.push({
    icon: 'üìä',
    title: 'Daily Report',
    description: 'Cash count and end-of-day reporting',
    link: '/daily-report.html'
  });
}

// Admin only features
if (currentUser.role === 'Admin') {
  navItems.push({
    icon: 'üë•',
    title: 'User Management',
    description: 'Create and manage user accounts',
    link: '/admin.html'
  });
}

      // Build navigation cards
   navGrid.innerHTML = navItems.map(item => `
  <a href="${item.link}" class="nav-card" ${item.id ? `id="${item.id}"` : ''}>
    <div class="nav-card-icon">${item.icon}</div>
    <h3>${item.title}${item.id === 'communication-card' ? '<span id="unreadBadge" class="unread-badge" style="display: none;">0</span>' : ''}</h3>
    <p>${item.description}</p>
  </a>
`).join('');

// Update unread count if Communication Log is visible
if (currentUser.role !== 'Employee') {
  updateUnreadCount();
}

    }

    function handleLogout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/';
      }
    }

    // Function to update unread count badge
async function updateUnreadCount() {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('/api/communication/unread-count', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    if (response.ok) {
      const data = await response.json();
      const badge = document.getElementById('unreadBadge');
      
      if (badge) {
        if (data.unread_count > 0) {
          badge.textContent = data.unread_count;
          badge.style.display = 'inline-block';
        } else {
          badge.style.display = 'none';
        }
      }
    }
  } catch (error) {
    console.error('Error fetching unread count:', error);
  }
}

// Update unread count every 30 seconds
setInterval(() => {
  if (currentUser && currentUser.role !== 'Employee') {
    updateUnreadCount();
  }
}, 30000);


  </script>
  <script src="/js/urgent-alerts.js"></script>
</body>
</html>