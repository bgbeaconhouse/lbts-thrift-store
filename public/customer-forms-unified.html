<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LBTS - Customer Forms</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #00a0e0 0%, #1a2f5c 100%);
      color: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 { font-size: 24px; }

    .back-link {
      color: white;
      text-decoration: none;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .back-link:hover { text-decoration: underline; }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .top-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .form-type-selector {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-type-selector label {
      font-weight: 600;
      color: #2d3748;
    }

    .form-type-selector select {
      padding: 10px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      min-width: 150px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #00a0e0;
      color: white;
    }

    .btn-primary:hover {
      background: #00a0e0;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #718096;
      color: white;
      padding: 8px 16px;
      font-size: 13px;
    }

    .btn-secondary:hover { background: #4a5568; }

    .btn-danger {
      background: #f56565;
      color: white;
      padding: 6px 12px;
      font-size: 13px;
    }

    .btn-danger:hover { background: #e53e3e; }

    .btn-success {
      background: #48bb78;
      color: white;
      padding: 8px 16px;
      font-size: 13px;
    }

    .btn-success:hover { background: #38a169; }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .filter-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e2e8f0;
      flex-wrap: wrap;
    }

    .filter-tab {
      padding: 12px 24px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      color: #718096;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .filter-tab:hover { color: #2d3748; }

    .filter-tab.active {
      color: #00a0e0;
      border-bottom-color: #00a0e0;
    }

    .search-box {
      margin-bottom: 20px;
    }

    .search-box input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
    }

    .search-box input:focus {
      outline: none;
      border-color: #00a0e0;
    }

    .forms-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .form-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      transition: all 0.3s;
    }

    .form-card:hover {
      box-shadow: 0 5px 20px rgba(0,0,0,0.12);
    }

    .form-card.email-success {
      border-left: 4px solid #48bb78;
    }

    .form-card.email-failed {
      border-left: 4px solid #f56565;
    }

    .form-card.deleted-form {
      opacity: 0.85;
      border: 2px solid #fed7d7;
      position: relative;
    }

    .deleted-banner {
      background: #f56565;
      color: white;
      padding: 8px 15px;
      margin: -20px -20px 15px -20px;
      font-size: 13px;
      font-weight: 600;
      border-radius: 8px 8px 0 0;
    }

    .type-badge {
      display: inline-block;
      background: #edf2f7;
      color: #4a5568;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-right: 8px;
    }

    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
      gap: 15px;
    }

    .form-info { flex: 1; }

    .customer-name {
      font-size: 18px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 5px;
    }

    .form-meta {
      color: #718096;
      font-size: 13px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .form-meta span {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-success {
      background: #48bb78;
      color: white;
    }

    .badge-warning {
      background: #f59e0b;
      color: white;
    }

    .badge-danger {
      background: #f56565;
      color: white;
    }

    .form-description {
      color: #4a5568;
      margin-top: 10px;
      line-height: 1.5;
    }

    .form-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .photos-preview {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .photo-thumb {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 5px;
      cursor: pointer;
      border: 2px solid #e2e8f0;
      transition: all 0.2s;
    }

    .photo-thumb:hover {
      border-color: #00a0e0;
      transform: scale(1.05);
    }

    .edit-photo-item {
      position: relative;
      display: inline-block;
    }

    .edit-photo-item img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 5px;
      border: 2px solid #e2e8f0;
    }

    .delete-photo-btn {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #f56565;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: all 0.2s;
    }

    .delete-photo-btn:hover {
      background: #e53e3e;
      transform: scale(1.1);
    }

    .signature-preview {
      margin-top: 10px;
      padding: 10px;
      background: #f7fafc;
      border-radius: 5px;
      display: inline-block;
    }

    .signature-preview img {
      max-width: 200px;
      max-height: 80px;
      border: 1px solid #e2e8f0;
      border-radius: 3px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #718096;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .empty-state h3 {
      font-size: 20px;
      color: #2d3748;
      margin-bottom: 10px;
    }

    .empty-state p {
      font-size: 14px;
    }

    .message {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .message.success {
      background: #f0fff4;
      color: #22543d;
      border: 1px solid #9ae6b4;
    }

    .message.error {
      background: #fff5f5;
      color: #742a2a;
      border: 1px solid #fc8181;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: flex-start;
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 10px;
      width: 100%;
      max-width: 800px;
      margin: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .modal-header {
      padding: 25px;
      border-bottom: 2px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      color: #2d3748;
      font-size: 22px;
    }

    .close-modal {
      font-size: 28px;
      color: #718096;
      cursor: pointer;
      border: none;
      background: none;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .close-modal:hover {
      background: #f7fafc;
      color: #2d3748;
    }

    .modal-body {
      padding: 25px;
      max-height: calc(90vh - 150px);
      overflow-y: auto;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2d3748;
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #00a0e0;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    /* Signature Pad */
    .signature-pad {
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      background: white;
      margin-top: 10px;
    }

    .signature-canvas {
      width: 100%;
      height: 200px;
      touch-action: none;
      cursor: crosshair;
    }

    .signature-controls {
      padding: 10px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      justify-content: flex-end;
    }

    /* File Upload */
    .file-upload-area {
      border: 2px dashed #e2e8f0;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      background: #f7fafc;
      cursor: pointer;
      transition: all 0.2s;
    }

    .file-upload-area:hover {
      border-color: #00a0e0;
      background: #edf2f7;
    }

    .file-upload-area.dragover {
      border-color: #00a0e0;
      background: #ebf4ff;
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 10px;
      color: #cbd5e0;
    }

    .image-preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }

    .image-preview-item {
      position: relative;
      width: 100px;
      height: 100px;
    }

    .image-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 5px;
      border: 2px solid #e2e8f0;
    }

    .remove-image {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #f56565;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .remove-image:hover {
      background: #e53e3e;
    }

    /* Terms Boxes */
    .terms-box {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      font-size: 13px;
      line-height: 1.6;
      color: #856404;
    }

    .terms-box h4 {
      margin-bottom: 10px;
      font-size: 14px;
    }

    .terms-box ul {
      margin-left: 20px;
    }

    .terms-box li {
      margin-bottom: 5px;
    }

    .upload-status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      display: none;
    }

    .upload-status.active {
      display: block;
    }

    .upload-status.uploading {
      background: #ebf8ff;
      color: #2c5282;
      border: 1px solid #bee3f8;
    }

    .upload-status.success {
      background: #f0fff4;
      color: #22543d;
      border: 1px solid #9ae6b4;
    }

    /* Image Viewer Modal */
    .image-viewer-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .image-viewer-modal.active {
      display: flex;
    }

    .viewer-content {
      max-width: 90%;
      max-height: 90%;
      position: relative;
    }

    .viewer-main-image {
      max-width: 100%;
      max-height: 85vh;
      object-fit: contain;
    }

    .viewer-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      z-index: 10;
    }

    .viewer-close:hover {
      background: rgba(255,255,255,0.3);
    }

    .viewer-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
    }

    .viewer-nav:hover {
      background: rgba(255,255,255,0.3);
    }

    .viewer-nav-prev {
      left: 20px;
    }

    .viewer-nav-next {
      right: 20px;
    }

    .viewer-counter {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 14px;
    }

    .viewer-thumbnails {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .viewer-thumbnail {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 5px;
      cursor: pointer;
      border: 2px solid transparent;
      opacity: 0.6;
      transition: all 0.2s;
    }

    .viewer-thumbnail:hover {
      opacity: 1;
      border-color: white;
    }

    .viewer-thumbnail.active {
      opacity: 1;
      border-color: #00a0e0;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1>üìã Customer Forms</h1>
      <a href="/dashboard.html" class="back-link">‚Üê Back to Dashboard</a>
    </div>
  </div>

  <div class="container">
    <div id="message" class="message"></div>

    <!-- Top Controls -->
    <div class="top-controls">
      <div class="form-type-selector">
        <label for="formTypeSelect">Form Type:</label>
        <select id="formTypeSelect" onchange="handleDropdownChange()">
          <option value="pickup">Pick-Up</option>
          <option value="delivery">Delivery</option>
          <!-- <option value="donation">Donation</option> -->
          <option value="waiver">Waiver</option>
          <option value="recently-deleted">üóëÔ∏è Recently Deleted</option>
        </select>
      </div>
      <button class="btn btn-primary" id="newFormBtn" onclick="openCreateModal()">+ New Form</button>
    </div>

    <!-- Filter Tabs -->
    <div class="filter-tabs">
      <button class="filter-tab active" data-filter="pickup" onclick="setFilter('pickup')">Pick-Up</button>
      <button class="filter-tab" data-filter="delivery" onclick="setFilter('delivery')">Delivery</button>
      <button class="filter-tab" data-filter="donation" onclick="setFilter('donation')" style="display: none;">Donation</button>
      <button class="filter-tab" data-filter="waiver" onclick="setFilter('waiver')">Waiver</button>
      <button class="filter-tab" data-filter="recently-deleted" onclick="setFilter('recently-deleted')">üóëÔ∏è Recently Deleted</button>
    </div>

    <!-- Search Box -->
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search by customer name, phone, or email..." oninput="filterForms()">
    </div>

    <!-- Forms List -->
    <div id="formsList" class="forms-list"></div>
  </div>

  <!-- Create/Edit Form Modal -->
  <div id="formModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">New Form</h2>
        <button class="close-modal" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="customerForm" onsubmit="handleSubmit(event)">
          <!-- Customer Info -->
          <div class="form-row">
            <div class="form-group">
              <label for="customer_name">Customer Name *</label>
              <input type="text" id="customer_name" required>
            </div>
            <div class="form-group">
              <label for="phone">Phone *</label>
              <input type="tel" id="phone" required placeholder="(555) 123-4567" maxlength="14" minlength="14">
            </div>
          </div>

          <div class="form-group">
            <label for="email">Email (for receipt)</label>
            <input type="email" id="email">
          </div>

          <!-- Pickup-specific fields -->
          <div id="pickupFields" style="display: none;">
            <div class="form-row">
              <div class="form-group">
                <label for="date_purchased">Date Purchased</label>
                <input type="date" id="date_purchased">
              </div>
              <div class="form-group">
                <label for="date_stored">Pick-Up Date *</label>
                <input type="date" id="date_stored">
              </div>
            </div>

            <div class="form-group">
              <label for="items_description_pickup">Items Description</label>
              <textarea id="items_description_pickup"></textarea>
            </div>

            <div class="form-group">
              <label>Photos (optional)</label>
              <input type="file" id="pictures_pickup" accept="image/*" multiple style="display: none;" onchange="handleFileSelect(event)">
              <div class="file-upload-area" onclick="document.getElementById('pictures_pickup').click()">
                <div class="upload-icon">üì∑</div>
                <p>Click to upload photos or drag and drop</p>
                <small>Up to 10 images</small>
              </div>
              <div id="imagePreviews_pickup" class="image-preview-container"></div>
            </div>

            <!-- Pickup Terms -->
            <div class="terms-box">
              <h4>‚ö†Ô∏è Pick-Up Terms & Conditions</h4>
              <p>You have <strong>48 hours upon purchase</strong> to pick your item up. After 48 hours the item will be placed back on the sales floor and <strong>no refunds will be issued</strong>.</p>
              <p style="margin-top: 10px;">We will gladly assist you in loading your items. Please be aware that it is the customer's responsibility to ensure items are properly loaded and secured.</p>
            </div>
          </div>

          <!-- Delivery-specific fields -->
          <div id="deliveryFields" style="display: none;">
            <div class="form-group">
              <label for="delivery_address">Delivery Address *</label>
              <textarea id="delivery_address" rows="3"></textarea>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="delivery_cost">Delivery Cost *</label>
                <input type="number" id="delivery_cost" step="0.01" min="0">
              </div>
              <div class="form-group">
                <label for="date_scheduled">Delivery Date *</label>
                <input type="date" id="date_scheduled">
              </div>
            </div>

            <div class="form-group">
              <label for="items_description_delivery">Items Description</label>
              <textarea id="items_description_delivery"></textarea>
            </div>

            <div class="form-group">
              <label>Photos (optional)</label>
              <input type="file" id="pictures_delivery" accept="image/*" multiple style="display: none;" onchange="handleFileSelect(event)">
              <div class="file-upload-area" onclick="document.getElementById('pictures_delivery').click()">
                <div class="upload-icon">üì∑</div>
                <p>Click to upload photos or drag and drop</p>
                <small>Up to 10 images</small>
              </div>
              <div id="imagePreviews_delivery" class="image-preview-container"></div>
            </div>

            <!-- Delivery Terms -->
            <div class="terms-box">
              <h4>‚ö†Ô∏è Delivery Information</h4>
              <p>I hereby acknowledge that my payment shown above is solely for the delivery of the item(s) to the residence indicated at the time of purchase. The Beacon House Thrift Shop is not responsible for moving said item(s) into said residence due to issues with liability. The item(s) will be placed in the driveway or the front yard.</p>
            </div>
          </div>

          <!-- Donation-specific fields -->
          <div id="donationFields" style="display: none;">
            <div class="form-group">
              <label for="donation_description">Donation Description</label>
              <textarea id="donation_description"></textarea>
            </div>

            <!-- Donation Terms -->
            <div class="terms-box">
              <h4>üìã Donation Acknowledgment</h4>
              <p>Thank you for your generous donation. No one has ever been turned away from the Beacon House Association of San Pedro due to their inability to pay, and because of friends like you, this policy will continue in the future.</p>
              <p style="margin-top: 10px;">No goods or services will be transferred to you in connection with this donation.</p>
              <p style="margin-top: 10px;"><strong>For your records our tax ID is #23-7376148</strong></p>
            </div>
          </div>

          <!-- Waiver-specific fields -->
          <div id="waiverFields" style="display: none;">
            <!-- Waiver Terms -->
            <div class="terms-box">
              <h4>‚ö†Ô∏è Release of Liability Form for Loading Purchased Furniture</h4>
              <p style="margin-bottom: 15px;">By signing this form, you acknowledge and agree to the following:</p>
              <ul style="margin-left: 20px; line-height: 1.8;">
                <li><strong>Voluntary Participation:</strong> The loading of furniture into your vehicle is a voluntary service.</li>
                <li><strong>Release of Liability:</strong> You release The Beacon House Association of San Pedro from any claims related to loss, damage, or injury during the loading process.</li>
                <li><strong>Assumption of Risks:</strong> You voluntarily assume all risks associated with loading furniture.</li>
                <li><strong>Care and Supervision:</strong> You are responsible for ensuring your vehicle is suitable for loading furniture.</li>
                <li><strong>Indemnification:</strong> You agree to hold harmless The Beacon House Association from any claims arising from the loading service.</li>
                <li><strong>Vehicle Inspection:</strong> Your vehicle was inspected before loading to ensure it is safe and suitable.</li>
                <li><strong>Personal Property:</strong> You are responsible for any personal belongings left in your vehicle.</li>
                <li><strong>Compliance:</strong> You agree to follow all instructions provided by staff during the loading process.</li>
              </ul>
            </div>
          </div>

          <!-- Customer Signature (all forms) -->
          <div id="signatureSection" class="form-group">
            <label>Customer Signature</label>
            <div class="signature-pad">
              <canvas id="signatureCanvas" class="signature-canvas"></canvas>
              <div class="signature-controls">
                <button type="button" class="btn btn-secondary" onclick="clearSignature()">Clear</button>
              </div>
            </div>
            <div id="signatureStatus" class="upload-status"></div>
          </div>

          <!-- Manager Signature (waiver only) -->
          <div id="managerSignatureSection" class="form-group" style="display: none;">
            <label>Manager Signature</label>
            <div class="signature-pad">
              <canvas id="managerSignatureCanvas" class="signature-canvas"></canvas>
              <div class="signature-controls">
                <button type="button" class="btn btn-secondary" onclick="clearManagerSignature()">Clear</button>
              </div>
            </div>
            <div id="managerSignatureStatus" class="upload-status"></div>
          </div>

          <button type="submit" id="submitBtn" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
            Create Form
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Image Viewer Modal -->
  <div id="imageViewerModal" class="image-viewer-modal" onclick="closeImageViewer(event)">
    <button class="viewer-close" onclick="closeImageViewer(event)">&times;</button>
    <button class="viewer-nav viewer-nav-prev" onclick="viewerPrevImage(event)">‚Äπ</button>
    <button class="viewer-nav viewer-nav-next" onclick="viewerNextImage(event)">‚Ä∫</button>
    <div class="viewer-content" onclick="event.stopPropagation()">
      <img id="viewerMainImage" class="viewer-main-image" src="" alt="Full size image">
      <div class="viewer-counter" id="viewerCounter">1 / 1</div>
      <div id="viewerThumbnails" class="viewer-thumbnails"></div>
    </div>
  </div>

  <!-- Conversion Modal -->
  <div id="convertModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="convertModalTitle">Convert Form</h2>
        <button class="close-modal" onclick="closeConvertModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="convertForm" onsubmit="handleConvertSubmit(event)">
          <input type="hidden" id="convert_original_type">
          <input type="hidden" id="convert_original_id">
          
          <!-- Delivery-specific fields (shown when converting pickup to delivery) -->
          <div id="convertDeliveryFields" style="display: none;">
            <div class="form-group">
              <label for="convert_delivery_address">Delivery Address *</label>
              <textarea id="convert_delivery_address" rows="3" required></textarea>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="convert_delivery_cost">Delivery Cost *</label>
                <input type="number" id="convert_delivery_cost" step="0.01" min="0" required>
              </div>
              <div class="form-group">
                <label for="convert_date_scheduled">Delivery Date *</label>
                <input type="date" id="convert_date_scheduled" required>
              </div>
            </div>

            <!-- Delivery Terms -->
            <div class="terms-box" style="margin-top: 20px;">
              <h4>‚ö†Ô∏è Delivery Terms (Customer Will Receive)</h4>
              <p>I hereby acknowledge that my payment shown above is solely for the delivery of the item(s) to the residence indicated at the time of purchase. The Beacon House Thrift Shop is not responsible for moving said item(s) into said residence due to issues with liability. The item(s) will be placed in the driveway or the front yard.</p>
            </div>
          </div>

          <!-- Pickup-specific fields (shown when converting delivery to pickup) -->
          <div id="convertPickupFields" style="display: none;">
            <div class="form-row">
              <div class="form-group">
                <label for="convert_date_purchased">Date Purchased</label>
                <input type="date" id="convert_date_purchased">
              </div>
              <div class="form-group">
                <label for="convert_date_stored">Pick-Up Date *</label>
                <input type="date" id="convert_date_stored" required>
              </div>
            </div>

            <!-- Pickup Terms -->
            <div class="terms-box" style="margin-top: 20px;">
              <h4>‚ö†Ô∏è Pick-Up Terms (Customer Will Receive)</h4>
              <p>You have <strong>48 hours upon purchase</strong> to pick your item up. After 48 hours the item will be placed back on the sales floor and <strong>no refunds will be issued</strong>.</p>
              <p style="margin-top: 10px;">We will gladly assist you in loading your items. Please be aware that it is the customer's responsibility to ensure items are properly loaded and secured. We are not responsible for any damage caused by loading or failure to secure items.</p>
              <p style="margin-top: 10px;">Your signature acknowledges that you have read and understand the terms and conditions covered above.</p>
            </div>
          </div>

          <!-- Customer Signature (required for conversion) -->
          <div class="form-group" style="margin-top: 20px;">
            <label>Customer Signature *</label>
            <div class="signature-pad">
              <canvas id="convertSignatureCanvas" class="signature-canvas"></canvas>
              <div class="signature-controls">
                <button type="button" class="btn btn-secondary" onclick="clearConvertSignature()">Clear</button>
              </div>
            </div>
          </div>

          <button type="submit" id="convertSubmitBtn" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
            Convert Form
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Form Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="editModalTitle">Edit Form</h2>
        <button class="close-modal" onclick="closeEditModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="editForm" onsubmit="handleEditSubmit(event)">
          <input type="hidden" id="edit_form_type">
          <input type="hidden" id="edit_form_id">
          
          <!-- Common fields -->
          <div class="form-group">
            <label for="edit_customer_name">Customer Name *</label>
            <input type="text" id="edit_customer_name" required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="edit_phone">Phone Number *</label>
              <input type="tel" id="edit_phone" required>
            </div>
            <div class="form-group">
              <label for="edit_email">Email (Optional)</label>
              <input type="email" id="edit_email">
            </div>
          </div>

          <div class="form-group">
            <label for="edit_items_description">Items Description</label>
            <textarea id="edit_items_description" rows="3"></textarea>
          </div>

          <!-- Pickup-specific fields -->
          <div id="editPickupFields" style="display: none;">
            <div class="form-row">
              <div class="form-group">
                <label for="edit_date_purchased">Date Purchased</label>
                <input type="date" id="edit_date_purchased">
              </div>
              <div class="form-group">
                <label for="edit_date_stored">Pick-Up Date *</label>
                <input type="date" id="edit_date_stored" required>
              </div>
            </div>
          </div>

          <!-- Delivery-specific fields -->
          <div id="editDeliveryFields" style="display: none;">
            <div class="form-group">
              <label for="edit_delivery_address">Delivery Address *</label>
              <textarea id="edit_delivery_address" rows="3" required></textarea>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="edit_delivery_cost">Delivery Cost *</label>
                <input type="number" id="edit_delivery_cost" step="0.01" min="0" required>
              </div>
              <div class="form-group">
                <label for="edit_date_scheduled">Delivery Date *</label>
                <input type="date" id="edit_date_scheduled" required>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="edit_notes">Notes</label>
            <textarea id="edit_notes" rows="2"></textarea>
          </div>

          <!-- Photo Management -->
          <div class="form-group">
            <label>Current Photos</label>
            <div id="editPhotosList" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
              <!-- Existing photos will be loaded here -->
            </div>
            <div id="editNoPhotosMessage" style="display: none; color: #718096; font-size: 14px; margin-top: 10px;">
              No photos attached
            </div>
          </div>

          <!-- Add New Photos -->
          <div class="form-group">
            <label for="edit_new_photos">Add New Photos (Optional)</label>
            <div style="font-size: 12px; color: #718096; margin-bottom: 5px;">You can select multiple photos at once or add more photos multiple times</div>
            <input type="file" id="edit_new_photos" accept="image/*" multiple style="margin-top: 5px;">
            <div id="editNewPhotosPreview" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
              <!-- New photos preview will appear here -->
            </div>
          </div>

          <button type="submit" id="editSubmitBtn" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
            Save Changes
          </button>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Global state
    let allForms = [];
    let currentFilter = 'pickup';
    let selectedFiles = [];
    let isSubmitting = false;
    let currentFormPhotos = []; // Track current photos in edit mode
    let photosToDelete = []; // Track photos marked for deletion
    let newPhotosToUpload = []; // Track new photos to add during edit
    
    // Signature pad setup
    let canvas, ctx, isDrawing = false;
    let managerCanvas, managerCtx, isDrawingManager = false;
    let convertCanvas, convertCtx, isDrawingConvert = false;

    // Image viewer
    let viewerImages = [];
    let currentViewerIndex = 0;
    let touchStartX = 0;
    let touchEndX = 0;

    // Initialize on page load
    window.onload = () => {
      checkAuth();
      loadAllForms();
      initSignaturePad();
      initManagerSignaturePad();
      initPhoneFormatting();
    };

    // Phone number formatting
    function initPhoneFormatting() {
      const phoneInput = document.getElementById('phone');
      if (phoneInput) {
        phoneInput.addEventListener('input', formatPhoneNumber);
      }
    }

    function formatPhoneNumber(e) {
      let input = e.target.value.replace(/\D/g, ''); // Remove all non-digits
      let formatted = '';

      if (input.length > 0) {
        formatted = '(' + input.substring(0, 3);
      }
      if (input.length >= 4) {
        formatted += ') ' + input.substring(3, 6);
      }
      if (input.length >= 7) {
        formatted += '-' + input.substring(6, 10);
      }

      e.target.value = formatted;
    }

    function checkAuth() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/';
        return;
      }
    }

    // Load all forms
    async function loadAllForms() {
      const token = localStorage.getItem('token');
      const types = ['pickup', 'delivery', 'donation', 'waiver'];
      
      allForms = [];
      
      for (const type of types) {
        try {
          const response = await fetch(`/api/customer-forms-unified/${type}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (response.ok) {
            const data = await response.json();
            // Add type to each form for filtering
            const formsWithType = data.forms.map(form => ({ ...form, form_type: type }));
            allForms = allForms.concat(formsWithType);
          }
        } catch (error) {
          console.error(`Error loading ${type} forms:`, error);
        }
      }
      
      // Sort by created_at desc
      allForms.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      
      filterForms();
    }

    // Load recently deleted forms (all types combined)
    async function loadRecentlyDeletedForms() {
      const token = localStorage.getItem('token');
      const types = ['pickup', 'delivery', 'donation', 'waiver'];
      
      let deletedForms = [];
      
      for (const type of types) {
        try {
          const response = await fetch(`/api/customer-forms-unified/${type}/recently-deleted`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (response.ok) {
            const data = await response.json();
            // Add type to each form for display
            const formsWithType = data.forms.map(form => ({ 
              ...form, 
              form_type: type,
              _isDeleted: true
            }));
            deletedForms = deletedForms.concat(formsWithType);
          }
        } catch (error) {
          console.error(`Error loading deleted ${type} forms:`, error);
        }
      }
      
      // Sort by deleted_at desc (most recently deleted first)
      deletedForms.sort((a, b) => new Date(b.deleted_at) - new Date(a.deleted_at));
      
      displayForms(deletedForms);
    }

    // Set filter
    function setFilter(filter) {
      currentFilter = filter;
      
      // Hide/show New Form button based on filter
      const newFormBtn = document.getElementById('newFormBtn');
      if (newFormBtn) {
        newFormBtn.style.display = filter === 'recently-deleted' ? 'none' : 'inline-block';
      }
      
      // Update active tab
      document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.filter === filter) {
          tab.classList.add('active');
        }
      });
      
      // Update dropdown to match the filter
      document.getElementById('formTypeSelect').value = filter;
      
      // If recently-deleted is selected, load deleted forms
      if (filter === 'recently-deleted') {
        loadRecentlyDeletedForms();
      } else {
        filterForms();
      }
    }

    // Handle dropdown change - sync tabs with dropdown selection
    function handleDropdownChange() {
      const selectedType = document.getElementById('formTypeSelect').value;
      setFilter(selectedType);
    }

    // Filter and display forms
    function filterForms() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      let filtered = allForms;
      
      // Skip filtering for recently-deleted (uses different data source)
      if (currentFilter === 'recently-deleted') {
        return;
      }
      
      // Filter by type (always filter since we removed 'all')
      filtered = filtered.filter(form => form.form_type === currentFilter);
      
      // Filter by search term
      if (searchTerm) {
        filtered = filtered.filter(form => 
          form.customer_name.toLowerCase().includes(searchTerm) ||
          (form.phone && form.phone.toLowerCase().includes(searchTerm)) ||
          (form.email && form.email.toLowerCase().includes(searchTerm))
        );
      }
      
      displayForms(filtered);
    }

    // Display forms
    function displayForms(forms) {
      const list = document.getElementById('formsList');
      
      if (forms.length === 0) {
        const emptyMessage = currentFilter === 'recently-deleted' 
          ? 'No recently deleted forms'
          : 'No forms found';
        const emptySubtext = currentFilter === 'recently-deleted'
          ? 'Deleted forms appear here for 7 days before being permanently removed'
          : 'Create your first form using the "New Form" button above';
        
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">${currentFilter === 'recently-deleted' ? 'üóëÔ∏è' : 'üìã'}</div>
            <h3>${emptyMessage}</h3>
            <p>${emptySubtext}</p>
          </div>
        `;
        return;
      }
      
      list.innerHTML = forms.map(form => {
        const isDeleted = form._isDeleted || false;
        const daysDeleted = form.days_deleted ? Math.floor(form.days_deleted) : null;
        const daysRemaining = daysDeleted !== null ? 7 - daysDeleted : null;
        
        const emailClass = form.email_sent ? 'email-success' : (form.email_error ? 'email-failed' : '');
        const emailBadge = form.email_sent 
          ? '<span class="badge badge-success">‚úì Email Sent</span>'
          : form.email_error 
          ? '<span class="badge badge-danger">‚úó Email Failed</span>'
          : form.email 
          ? '<span class="badge badge-warning">‚è≥ No Email</span>'
          : '<span class="badge badge-warning">No Email Address</span>';
        
        const typeLabel = form.form_type.charAt(0).toUpperCase() + form.form_type.slice(1);
        
        let description = '';
        let notes = '';
        if (form.form_type === 'donation') {
          description = form.donation_description;
        } else if (form.form_type === 'pickup' || form.form_type === 'delivery') {
          description = form.items_description;
          notes = form.notes;
        }
        
        const hasPhotos = form.picture_urls && form.picture_urls.length > 0;
        
        return `
          <div class="form-card ${emailClass} ${isDeleted ? 'deleted-form' : ''}">
            ${isDeleted && daysRemaining !== null ? `
              <div class="deleted-banner">
                üóëÔ∏è Deleted ${new Date(form.deleted_at).toLocaleDateString()} - 
                <strong>${daysRemaining > 1 ? `${daysRemaining} days remaining` : daysRemaining === 1 ? '1 day remaining' : 'Expires soon'}</strong>
              </div>
            ` : ''}
            <div class="form-header">
              <div class="form-info">
                <div class="customer-name">
                  ${isDeleted ? `<span class="type-badge">${typeLabel}</span> ` : ''}${escapeHtml(form.customer_name)}
                </div>
                <div class="form-meta">
                  ${!isDeleted ? `<span><strong>${typeLabel}</strong></span>` : ''}
                  <span>üìû ${escapeHtml(form.phone)}</span>
                  ${form.email ? `<span>üìß ${escapeHtml(form.email)}</span>` : ''}
                  ${form.date_purchased ? `<span>üìÖ Purchased: ${formatDateForDisplay(form.date_purchased)}</span>` : ''}
                 ${form.date_scheduled || form.date_stored ? `<span>üóìÔ∏è ${form.form_type === 'delivery' ? 'Delivery' : 'Pickup'}: ${formatDateForDisplay(form.date_scheduled || form.date_stored)}</span>` : ''}
                  ${form.delivery_cost ? `<span>üíµ $${parseFloat(form.delivery_cost).toFixed(2)}</span>` : ''}
                  ${!isDeleted ? `<span>${emailBadge}</span>` : ''}
                </div>
                ${description ? `<div class="form-description">${escapeHtml(description).substring(0, 150)}${description.length > 150 ? '...' : ''}</div>` : ''}
                ${notes ? `<div class="form-description" style="background: #fff3cd; border-left: 3px solid #ffc107; padding: 8px; margin-top: 8px; border-radius: 4px;"><strong>üìù Notes:</strong> ${escapeHtml(notes).substring(0, 150)}${notes.length > 150 ? '...' : ''}</div>` : ''}
                ${form.delivery_address ? `<div class="form-description" style="background: #e6f3ff; border-left: 3px solid #00a0e0; padding: 8px; margin-top: 8px; border-radius: 4px;"><strong>üìç Delivery Address:</strong> ${escapeHtml(form.delivery_address)}</div>` : ''}
                ${hasPhotos ? `
                  <div class="photos-preview">
                    ${form.picture_urls.slice(0, 5).map(url => `
                      <img src="${url}" alt="Item photo" class="photo-thumb" onclick="openImageViewer(${JSON.stringify(form.picture_urls).replace(/"/g, '&quot;')})">
                    `).join('')}
                    ${form.picture_urls.length > 5 ? `<div style="font-size: 12px; color: #718096; display: flex; align-items: center;">+${form.picture_urls.length - 5} more</div>` : ''}
                  </div>
                ` : ''}
                ${form.signature_url ? `
                  <div class="signature-preview">
                    <div style="font-size: 12px; color: #718096; margin-bottom: 5px;">Customer Signature:</div>
                    <img src="${form.signature_url}" alt="Signature">
                  </div>
                ` : ''}
              </div>
              <div class="form-actions">
                ${isDeleted ? `
                  <button class="btn btn-success" onclick="restoreForm('${form.form_type}', ${form.id})">‚Ü©Ô∏è Restore</button>
                ` : `
                  ${(form.form_type === 'pickup' || form.form_type === 'delivery') ? `
                    <button class="btn btn-secondary" onclick="openEditModal('${form.form_type}', ${form.id})">Edit</button>
                  ` : ''}
                  ${form.form_type === 'pickup' ? `
                    <button class="btn btn-secondary" onclick="openConvertModal('${form.form_type}', ${form.id})">Switch to Delivery</button>
                  ` : ''}
                  ${form.form_type === 'delivery' ? `
                    <button class="btn btn-secondary" onclick="openConvertModal('${form.form_type}', ${form.id})">Switch to Pickup</button>
                  ` : ''}
                  ${form.email && form.email_error ? `
                    <button class="btn btn-success" onclick="retryEmail('${form.form_type}', ${form.id})">Retry Email</button>
                  ` : ''}
                  <button class="btn btn-danger" onclick="deleteForm('${form.form_type}', ${form.id})">Delete</button>
                `}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Open create modal
    function openCreateModal() {
      const formType = document.getElementById('formTypeSelect').value;
      const typeNames = {
        pickup: 'Pick-Up',
        delivery: 'Delivery',
        donation: 'Donation',
        waiver: 'Waiver'
      };
      
      document.getElementById('modalTitle').textContent = `New ${typeNames[formType]} Form`;
      document.getElementById('customerForm').reset();
      clearSignature();
      clearManagerSignature();
      selectedFiles = [];
      
      // Show/hide fields based on form type
      document.getElementById('pickupFields').style.display = formType === 'pickup' ? 'block' : 'none';
      document.getElementById('deliveryFields').style.display = formType === 'delivery' ? 'block' : 'none';
      document.getElementById('donationFields').style.display = formType === 'donation' ? 'block' : 'none';
      document.getElementById('waiverFields').style.display = formType === 'waiver' ? 'block' : 'none';
      document.getElementById('managerSignatureSection').style.display = formType === 'waiver' ? 'block' : 'none';
      
      // Clear image previews
      document.getElementById('imagePreviews_pickup').innerHTML = '';
      document.getElementById('imagePreviews_delivery').innerHTML = '';
      
      document.getElementById('formModal').classList.add('active');
      
      // Re-initialize canvas and phone formatting after modal is visible
      setTimeout(() => {
        initSignaturePad();
        initManagerSignaturePad();
        initPhoneFormatting();
      }, 100);
    }

    function closeModal() {
      document.getElementById('formModal').classList.remove('active');
      document.getElementById('customerForm').reset();
      selectedFiles = [];
      isSubmitting = false;
    }

    // Initialize signature pad
    function initSignaturePad() {
      canvas = document.getElementById('signatureCanvas');
      if (!canvas) return;
      
      ctx = canvas.getContext('2d');
      
      // Set canvas size
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
      
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      
      // Mouse events
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);
      
      // Touch events
      canvas.addEventListener('touchstart', handleTouchStart);
      canvas.addEventListener('touchmove', handleTouchMove);
      canvas.addEventListener('touchend', stopDrawing);
    }

    function initManagerSignaturePad() {
      managerCanvas = document.getElementById('managerSignatureCanvas');
      if (!managerCanvas) return;
      
      managerCtx = managerCanvas.getContext('2d');
      
      const rect = managerCanvas.getBoundingClientRect();
      managerCanvas.width = rect.width;
      managerCanvas.height = rect.height;
      
      managerCtx.strokeStyle = '#000';
      managerCtx.lineWidth = 2;
      managerCtx.lineCap = 'round';
      
      managerCanvas.addEventListener('mousedown', (e) => startDrawing(e, true));
      managerCanvas.addEventListener('mousemove', (e) => draw(e, true));
      managerCanvas.addEventListener('mouseup', stopDrawing);
      managerCanvas.addEventListener('mouseout', stopDrawing);
      
      managerCanvas.addEventListener('touchstart', (e) => handleTouchStart(e, true));
      managerCanvas.addEventListener('touchmove', (e) => handleTouchMove(e, true));
      managerCanvas.addEventListener('touchend', stopDrawing);
    }

    function initConvertSignaturePad() {
      convertCanvas = document.getElementById('convertSignatureCanvas');
      if (!convertCanvas) return;
      
      convertCtx = convertCanvas.getContext('2d');
      
      const rect = convertCanvas.getBoundingClientRect();
      convertCanvas.width = rect.width;
      convertCanvas.height = rect.height;
      
      convertCtx.strokeStyle = '#000';
      convertCtx.lineWidth = 2;
      convertCtx.lineCap = 'round';
      
      convertCanvas.addEventListener('mousedown', (e) => startDrawing(e, 'convert'));
      convertCanvas.addEventListener('mousemove', (e) => draw(e, 'convert'));
      convertCanvas.addEventListener('mouseup', stopDrawing);
      convertCanvas.addEventListener('mouseout', stopDrawing);
      
      convertCanvas.addEventListener('touchstart', (e) => handleTouchStart(e, 'convert'));
      convertCanvas.addEventListener('touchmove', (e) => handleTouchMove(e, 'convert'));
      convertCanvas.addEventListener('touchend', stopDrawing);
    }

    function startDrawing(e, isManager = false) {
      if (isManager === 'convert') {
        isDrawingConvert = true;
        const rect = convertCanvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        convertCtx.beginPath();
        convertCtx.moveTo(x, y);
      } else if (isManager) {
        isDrawingManager = true;
        const rect = managerCanvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        managerCtx.beginPath();
        managerCtx.moveTo(x, y);
      } else {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        ctx.beginPath();
        ctx.moveTo(x, y);
      }
    }

    function draw(e, isManager = false) {
      if (isManager === 'convert' && !isDrawingConvert) return;
      if (isManager === true && !isDrawingManager) return;
      if (!isManager && !isDrawing) return;
      
      let targetCanvas, targetCtx;
      if (isManager === 'convert') {
        targetCanvas = convertCanvas;
        targetCtx = convertCtx;
      } else if (isManager) {
        targetCanvas = managerCanvas;
        targetCtx = managerCtx;
      } else {
        targetCanvas = canvas;
        targetCtx = ctx;
      }
      
      const rect = targetCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      targetCtx.lineTo(x, y);
      targetCtx.stroke();
    }

    function stopDrawing() {
      isDrawing = false;
      isDrawingManager = false;
      isDrawingConvert = false;
    }

    function handleTouchStart(e, isManager = false) {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousedown', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      if (isManager === 'convert') {
        convertCanvas.dispatchEvent(mouseEvent);
      } else if (isManager) {
        managerCanvas.dispatchEvent(mouseEvent);
      } else {
        canvas.dispatchEvent(mouseEvent);
      }
    }

    function handleTouchMove(e, isManager = false) {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      if (isManager === 'convert') {
        convertCanvas.dispatchEvent(mouseEvent);
      } else if (isManager) {
        managerCanvas.dispatchEvent(mouseEvent);
      } else {
        canvas.dispatchEvent(mouseEvent);
      }
    }

    function clearSignature() {
      if (ctx && canvas) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
    }

    function clearManagerSignature() {
      if (managerCtx && managerCanvas) {
        managerCtx.clearRect(0, 0, managerCanvas.width, managerCanvas.height);
      }
    }

    function isSignatureEmpty() {
      if (!canvas || !ctx) return true;
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      return !imageData.data.some(channel => channel !== 0);
    }

    function isManagerSignatureEmpty() {
      if (!managerCanvas || !managerCtx) return true;
      const imageData = managerCtx.getImageData(0, 0, managerCanvas.width, managerCanvas.height);
      return !imageData.data.some(channel => channel !== 0);
    }

    function clearConvertSignature() {
      if (convertCtx && convertCanvas) {
        convertCtx.clearRect(0, 0, convertCanvas.width, convertCanvas.height);
      }
    }

    function isConvertSignatureEmpty() {
      if (!convertCanvas || !convertCtx) return true;
      const imageData = convertCtx.getImageData(0, 0, convertCanvas.width, convertCanvas.height);
      return !imageData.data.some(channel => channel !== 0);
    }

    // File handling
    async function handleFileSelect(event) {
      const files = Array.from(event.target.files);
      const formType = document.getElementById('formTypeSelect').value;
      
      // Check if adding new files would exceed limit
      if (selectedFiles.length + files.length > 10) {
        showMessage(`Cannot add ${files.length} more image(s). You can only have 10 images total. Currently have ${selectedFiles.length}.`, 'error');
        event.target.value = ''; // Clear the input
        return;
      }
      
      // Don't clear selectedFiles - keep existing images and add new ones
      const previewContainer = document.getElementById(`imagePreviews_${formType}`);
      
      for (const file of files) {
        // Compress image
        const compressed = await compressImage(file);
        const newIndex = selectedFiles.length;
        selectedFiles.push(compressed);
        
        // Show preview
        const reader = new FileReader();
        reader.onload = (e) => {
          const div = document.createElement('div');
          div.className = 'image-preview-item';
          div.innerHTML = `
            <img src="${e.target.result}" alt="Preview">
            <button type="button" class="remove-image" onclick="removeImage(${newIndex}, '${formType}')">&times;</button>
          `;
          previewContainer.appendChild(div);
        };
        reader.readAsDataURL(compressed);
      }
      
      // Clear the file input so user can select the same file again if needed
      event.target.value = '';
    }

    async function compressImage(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            const maxDimension = 1920;
            if (width > height && width > maxDimension) {
              height = (height * maxDimension) / width;
              width = maxDimension;
            } else if (height > maxDimension) {
              width = (width * maxDimension) / height;
              height = maxDimension;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            canvas.toBlob((blob) => {
              resolve(new File([blob], file.name, { type: 'image/jpeg' }));
            }, 'image/jpeg', 0.85);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    function removeImage(index, formType) {
      selectedFiles.splice(index, 1);
      
      // Refresh the entire preview with updated indices
      const previewContainer = document.getElementById(`imagePreviews_${formType}`);
      previewContainer.innerHTML = '';
      
      selectedFiles.forEach((file, idx) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const div = document.createElement('div');
          div.className = 'image-preview-item';
          div.innerHTML = `
            <img src="${e.target.result}" alt="Preview">
            <button type="button" class="remove-image" onclick="removeImage(${idx}, '${formType}')">&times;</button>
          `;
          previewContainer.appendChild(div);
        };
        reader.readAsDataURL(file);
      });
      
      // Clear the file input
      const input = document.getElementById(`pictures_${formType}`);
      if (input) input.value = '';
    }

    // Helper function to format date as local date string (YYYY-MM-DD) with timezone offset
    function formatDateForSubmission(dateString) {
      if (!dateString) return null;
      
      // Create a date at noon local time to avoid timezone shifts
      const [year, month, day] = dateString.split('-');
      const date = new Date(year, month - 1, day, 12, 0, 0);
      
      // Format as YYYY-MM-DD in local timezone
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const dd = String(date.getDate()).padStart(2, '0');
      
      return `${yyyy}-${mm}-${dd}`;
    }

    // Helper function to format date for display without timezone conversion
    function formatDateForDisplay(dateString) {
      if (!dateString) return 'N/A';
      
      // If it's a YYYY-MM-DD string, parse it manually to avoid timezone issues
      const match = dateString.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (match) {
        const year = match[1];
        const month = match[2];
        const day = match[3];
        
        // Create date at noon local time to prevent timezone shifts
        const date = new Date(year, month - 1, day, 12, 0, 0);
        
        return date.toLocaleDateString();
      }
      
      // Fallback to regular Date parsing for timestamps
      return new Date(dateString).toLocaleDateString();
    }

    // Form submission
    async function handleSubmit(event) {
      event.preventDefault();
      
      if (isSubmitting) {
        console.log('Form already submitting...');
        return;
      }
      
      // Validate phone number length
      const phoneInput = document.getElementById('phone');
      const phoneValue = phoneInput.value;
      if (phoneValue.length < 14) {
        showMessage('Please enter a complete 10-digit phone number', 'error');
        phoneInput.focus();
        return;
      }
      
      const token = localStorage.getItem('token');
      const formType = document.getElementById('formTypeSelect').value;
      const submitBtn = document.getElementById('submitBtn');
      
      isSubmitting = true;
      submitBtn.disabled = true;
      const originalBtnText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="loading-spinner"></span>Submitting...';
      
      const formData = new FormData();
      formData.append('form_type', formType);
      formData.append('customer_name', document.getElementById('customer_name').value);
      formData.append('phone', document.getElementById('phone').value);
      formData.append('email', document.getElementById('email').value);
      
      // Add type-specific fields
      if (formType === 'pickup') {
        const datePurchased = document.getElementById('date_purchased').value;
        const dateStored = document.getElementById('date_stored').value;
        const description = document.getElementById('items_description_pickup').value;
        
        if (datePurchased) formData.append('date_purchased', formatDateForSubmission(datePurchased));
        if (dateStored) formData.append('date_stored', formatDateForSubmission(dateStored));
        if (description) formData.append('items_description', description);
        
        // Add photos
        selectedFiles.forEach(file => {
          formData.append('pictures', file);
        });
        
      } else if (formType === 'delivery') {
        const address = document.getElementById('delivery_address').value;
        const cost = document.getElementById('delivery_cost').value;
        const dateScheduled = document.getElementById('date_scheduled').value;
        const description = document.getElementById('items_description_delivery').value;
        
        if (address) formData.append('delivery_address', address);
        if (cost) formData.append('delivery_cost', cost);
        if (dateScheduled) formData.append('date_scheduled', formatDateForSubmission(dateScheduled));
        if (description) formData.append('items_description', description);
        
        // Add photos
        selectedFiles.forEach(file => {
          formData.append('pictures', file);
        });
        
      } else if (formType === 'donation') {
        const description = document.getElementById('donation_description').value;
        if (description) formData.append('donation_description', description);
      }
      
      // Add signatures
      if (!isSignatureEmpty()) {
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        formData.append('signature', blob, 'signature.png');
      }
      
      if (formType === 'waiver' && !isManagerSignatureEmpty()) {
        const blob = await new Promise(resolve => managerCanvas.toBlob(resolve, 'image/png'));
        formData.append('manager_signature', blob, 'manager_signature.png');
      }
      
      try {
        const response = await fetch('/api/customer-forms-unified/create', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
          let message = data.message;
          if (data.emailSent) {
            message += ' and email sent to customer!';
          } else if (data.emailError) {
            message += ` but email failed: ${data.emailError}`;
          } else if (!data.form.email) {
            message += ' (no email address provided)';
          }
          
          showMessage(message, data.emailSent ? 'success' : 'error');
          closeModal();
          loadAllForms();
        } else {
          showMessage(data.error || 'Failed to create form', 'error');
        }
      } catch (error) {
        console.error('Submit error:', error);
        showMessage('Network error. Please try again.', 'error');
      } finally {
        isSubmitting = false;
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
      }
    }

    // Retry email
    async function retryEmail(type, id) {
      const token = localStorage.getItem('token');
      
      try {
        const response = await fetch(`/api/customer-forms-unified/retry-email/${type}/${id}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showMessage('Email sent successfully!', 'success');
          loadAllForms();
        } else {
          showMessage(data.error || 'Failed to send email', 'error');
        }
      } catch (error) {
        console.error('Retry email error:', error);
        showMessage('Network error. Please try again.', 'error');
      }
    }

    // Delete form
    async function deleteForm(type, id) {
      if (!confirm('Are you sure you want to delete this form?')) {
        return;
      }
      
      const token = localStorage.getItem('token');
      
      try {
        const response = await fetch(`/api/customer-forms-unified/${type}/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showMessage(data.message, 'success');
          loadAllForms();
        } else {
          showMessage(data.error || 'Delete failed', 'error');
        }
      } catch (error) {
        console.error('Delete error:', error);
        showMessage('Network error. Please try again.', 'error');
      }
    }

    async function restoreForm(type, id) {
      if (!confirm('Are you sure you want to restore this form?')) {
        return;
      }
      
      const token = localStorage.getItem('token');
      
      try {
        const response = await fetch(`/api/customer-forms-unified/${type}/${id}/restore`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showMessage(data.message + ' - Form restored successfully', 'success');
          loadRecentlyDeletedForms(); // Reload the recently deleted list
        } else {
          showMessage(data.error || 'Restore failed', 'error');
        }
      } catch (error) {
        console.error('Restore error:', error);
        showMessage('Network error. Please try again.', 'error');
      }
    }

    // Image viewer
    function openImageViewer(images) {
      viewerImages = images;
      currentViewerIndex = 0;
      showViewerImage(0);
      document.getElementById('imageViewerModal').classList.add('active');
      document.body.style.overflow = 'hidden';
      
      const mainImage = document.getElementById('viewerMainImage');
      mainImage.addEventListener('touchstart', handleViewerTouchStart, { passive: true });
      mainImage.addEventListener('touchend', handleViewerTouchEnd, { passive: true });
    }

    function closeImageViewer(event) {
      if (event && event.target !== event.currentTarget && !event.target.classList.contains('viewer-close')) {
        return;
      }
      document.getElementById('imageViewerModal').classList.remove('active');
      document.body.style.overflow = '';
      
      const mainImage = document.getElementById('viewerMainImage');
      mainImage.removeEventListener('touchstart', handleViewerTouchStart);
      mainImage.removeEventListener('touchend', handleViewerTouchEnd);
    }

    function showViewerImage(index) {
      if (viewerImages.length === 0) return;
      
      currentViewerIndex = index;
      const mainImage = document.getElementById('viewerMainImage');
      const counter = document.getElementById('viewerCounter');
      const thumbnailsContainer = document.getElementById('viewerThumbnails');
      
      mainImage.src = viewerImages[index];
      counter.textContent = `${index + 1} / ${viewerImages.length}`;
      
      thumbnailsContainer.innerHTML = viewerImages.map((url, i) => `
        <img src="${url}" 
             class="viewer-thumbnail ${i === index ? 'active' : ''}" 
             onclick="showViewerImage(${i})"
             alt="Thumbnail ${i + 1}">
      `).join('');
    }

    function viewerPrevImage(event) {
      event.stopPropagation();
      const newIndex = currentViewerIndex > 0 ? currentViewerIndex - 1 : viewerImages.length - 1;
      showViewerImage(newIndex);
    }

    function viewerNextImage(event) {
      event.stopPropagation();
      const newIndex = currentViewerIndex < viewerImages.length - 1 ? currentViewerIndex + 1 : 0;
      showViewerImage(newIndex);
    }

    function handleViewerTouchStart(event) {
      touchStartX = event.changedTouches[0].screenX;
    }

    function handleViewerTouchEnd(event) {
      touchEndX = event.changedTouches[0].screenX;
      const diff = touchStartX - touchEndX;
      const swipeThreshold = 50;
      
      if (Math.abs(diff) > swipeThreshold) {
        if (diff > 0) {
          viewerNextImage({ stopPropagation: () => {} });
        } else {
          viewerPrevImage({ stopPropagation: () => {} });
        }
      }
    }

    // Keyboard navigation
    document.addEventListener('keydown', function(event) {
      const modal = document.getElementById('imageViewerModal');
      if (!modal.classList.contains('active')) return;
      
      if (event.key === 'Escape') {
        closeImageViewer();
      } else if (event.key === 'ArrowLeft') {
        viewerPrevImage(event);
      } else if (event.key === 'ArrowRight') {
        viewerNextImage(event);
      }
    });

    // Utility functions
    function showMessage(text, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = text;
      messageDiv.className = `message ${type}`;
      messageDiv.style.display = 'block';
      
      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 5000);
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Conversion functions
    function openConvertModal(fromType, formId) {
      const targetType = fromType === 'pickup' ? 'delivery' : 'pickup';
      const form = allForms.find(f => f.form_type === fromType && f.id === formId);
      
      if (!form) {
        showMessage('Form not found', 'error');
        return;
      }
      
      document.getElementById('convert_original_type').value = fromType;
      document.getElementById('convert_original_id').value = formId;
      
      // Update modal title
      const titleText = fromType === 'pickup' 
        ? 'Convert Pickup to Delivery'
        : 'Convert Delivery to Pickup';
      document.getElementById('convertModalTitle').textContent = titleText;
      
      // Show/hide appropriate fields
      document.getElementById('convertDeliveryFields').style.display = 
        targetType === 'delivery' ? 'block' : 'none';
      document.getElementById('convertPickupFields').style.display = 
        targetType === 'pickup' ? 'block' : 'none';
      
      // Reset form
      document.getElementById('convertForm').reset();
      document.getElementById('convert_original_type').value = fromType;
      document.getElementById('convert_original_id').value = formId;
      
      // Set required attributes based on target type
      if (targetType === 'delivery') {
        document.getElementById('convert_delivery_address').required = true;
        document.getElementById('convert_delivery_cost').required = true;
        document.getElementById('convert_date_scheduled').required = true;
        document.getElementById('convert_date_stored').required = false;
      } else {
        document.getElementById('convert_delivery_address').required = false;
        document.getElementById('convert_delivery_cost').required = false;
        document.getElementById('convert_date_scheduled').required = false;
        document.getElementById('convert_date_stored').required = true;
      }
      
      document.getElementById('convertModal').classList.add('active');
      
      // Re-initialize signature canvas after modal is visible
      setTimeout(() => {
        initConvertSignaturePad();
      }, 100);
    }

    // Edit form functions
    function openEditModal(formType, formId) {
      const form = allForms.find(f => f.form_type === formType && f.id === formId);
      
      if (!form) {
        showMessage('Form not found', 'error');
        return;
      }
      
      // Store form type and ID
      document.getElementById('edit_form_type').value = formType;
      document.getElementById('edit_form_id').value = formId;
      
      // Set modal title
      document.getElementById('editModalTitle').textContent = 
        `Edit ${formType.charAt(0).toUpperCase() + formType.slice(1)} Form`;
      
      // Fill common fields
      document.getElementById('edit_customer_name').value = form.customer_name || '';
      document.getElementById('edit_phone').value = form.phone || '';
      document.getElementById('edit_email').value = form.email || '';
      document.getElementById('edit_items_description').value = form.items_description || '';
      document.getElementById('edit_notes').value = form.notes || '';
      
      // Show/hide appropriate fields
      if (formType === 'pickup') {
        document.getElementById('editPickupFields').style.display = 'block';
        document.getElementById('editDeliveryFields').style.display = 'none';
        
        document.getElementById('edit_date_purchased').value = form.date_purchased || '';
        document.getElementById('edit_date_stored').value = form.date_stored || '';
        document.getElementById('edit_date_stored').required = true;
        
        document.getElementById('edit_delivery_address').required = false;
        document.getElementById('edit_delivery_cost').required = false;
        document.getElementById('edit_date_scheduled').required = false;
      } else if (formType === 'delivery') {
        document.getElementById('editPickupFields').style.display = 'none';
        document.getElementById('editDeliveryFields').style.display = 'block';
        
        document.getElementById('edit_delivery_address').value = form.delivery_address || '';
        document.getElementById('edit_delivery_cost').value = form.delivery_cost || '';
        document.getElementById('edit_date_scheduled').value = form.date_scheduled || '';
        document.getElementById('edit_delivery_address').required = true;
        document.getElementById('edit_delivery_cost').required = true;
        document.getElementById('edit_date_scheduled').required = true;
        
        document.getElementById('edit_date_stored').required = false;
      }
      
      // Load and display photos
      currentFormPhotos = form.picture_urls || [];
      photosToDelete = [];
      displayEditPhotos();
      
      document.getElementById('editModal').classList.add('active');
    }

    function displayEditPhotos() {
      const photosList = document.getElementById('editPhotosList');
      const noPhotosMsg = document.getElementById('editNoPhotosMessage');
      
      if (currentFormPhotos.length === 0) {
        photosList.style.display = 'none';
        noPhotosMsg.style.display = 'block';
        return;
      }
      
      photosList.style.display = 'flex';
      noPhotosMsg.style.display = 'none';
      photosList.innerHTML = currentFormPhotos.map((url, index) => `
        <div class="edit-photo-item">
          <img src="${url}" alt="Photo ${index + 1}">
          <button type="button" class="delete-photo-btn" onclick="markPhotoForDeletion(${index})" title="Delete photo">√ó</button>
        </div>
      `).join('');
    }

    function markPhotoForDeletion(photoIndex) {
      const photoUrl = currentFormPhotos[photoIndex];
      
      if (!confirm('Are you sure you want to delete this photo?')) {
        return;
      }
      
      // Add to deletion list
      photosToDelete.push(photoUrl);
      
      // Remove from current photos
      currentFormPhotos.splice(photoIndex, 1);
      
      // Refresh display
      displayEditPhotos();
    }

    // Handle new photo uploads in edit mode
    document.addEventListener('DOMContentLoaded', function() {
      const editNewPhotosInput = document.getElementById('edit_new_photos');
      if (editNewPhotosInput) {
        editNewPhotosInput.addEventListener('change', function(e) {
          const newFiles = Array.from(e.target.files);
          
          // Add new files to existing array (accumulate instead of replace)
          newPhotosToUpload = [...newPhotosToUpload, ...newFiles];
          
          // Display preview of ALL photos
          displayNewPhotosPreview();
          
          // Clear the file input so the same file can be selected again if needed
          e.target.value = '';
        });
      }
    });

    function displayNewPhotosPreview() {
      const previewContainer = document.getElementById('editNewPhotosPreview');
      previewContainer.innerHTML = '';
      
      newPhotosToUpload.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const photoItem = document.createElement('div');
          photoItem.className = 'edit-photo-item';
          photoItem.innerHTML = `
            <img src="${e.target.result}" alt="New photo ${index + 1}">
            <button type="button" class="delete-photo-btn" onclick="removeNewPhoto(${index})" title="Remove photo">√ó</button>
          `;
          previewContainer.appendChild(photoItem);
        };
        reader.readAsDataURL(file);
      });
    }

    function removeNewPhoto(index) {
      newPhotosToUpload.splice(index, 1);
      displayNewPhotosPreview();
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
      document.getElementById('editForm').reset();
      currentFormPhotos = [];
      photosToDelete = [];
      newPhotosToUpload = [];
      document.getElementById('editNewPhotosPreview').innerHTML = '';
    }

    async function handleEditSubmit(event) {
      event.preventDefault();
      
      const token = localStorage.getItem('token');
      const formType = document.getElementById('edit_form_type').value;
      const formId = document.getElementById('edit_form_id').value;
      
      const submitBtn = document.getElementById('editSubmitBtn');
      submitBtn.disabled = true;
      const originalBtnText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="loading-spinner"></span>Saving...';
      
      // Use FormData to support file uploads
      const formData = new FormData();
      formData.append('customer_name', document.getElementById('edit_customer_name').value);
      formData.append('phone', document.getElementById('edit_phone').value);
      formData.append('email', document.getElementById('edit_email').value);
      formData.append('items_description', document.getElementById('edit_items_description').value);
      formData.append('notes', document.getElementById('edit_notes').value);
      
      // Add type-specific fields
      if (formType === 'pickup') {
        const datePurchased = document.getElementById('edit_date_purchased').value;
        const dateStored = document.getElementById('edit_date_stored').value;
        
        if (datePurchased) formData.append('date_purchased', formatDateForSubmission(datePurchased));
        if (dateStored) formData.append('date_stored', formatDateForSubmission(dateStored));
      } else if (formType === 'delivery') {
        formData.append('delivery_address', document.getElementById('edit_delivery_address').value);
        formData.append('delivery_cost', document.getElementById('edit_delivery_cost').value);
        
        const dateScheduled = document.getElementById('edit_date_scheduled').value;
        if (dateScheduled) formData.append('date_scheduled', formatDateForSubmission(dateScheduled));
      }
      
      // Add photos to delete
      if (photosToDelete.length > 0) {
        formData.append('photos_to_delete', JSON.stringify(photosToDelete));
      }
      
      // Add new photos
      newPhotosToUpload.forEach(file => {
        formData.append('new_pictures', file);
      });
      
      try {
        const response = await fetch(`/api/customer-forms-unified/${formType}/${formId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showMessage('Form updated successfully!', 'success');
          closeEditModal();
          loadAllForms();
        } else {
          showMessage(data.error || 'Failed to update form', 'error');
        }
      } catch (error) {
        console.error('Update error:', error);
        showMessage('Network error. Please try again.', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
      }
    }

    function closeConvertModal() {
      document.getElementById('convertModal').classList.remove('active');
      document.getElementById('convertForm').reset();
      clearConvertSignature();
    }

    async function handleConvertSubmit(event) {
      event.preventDefault();
      
      // Validate signature
      if (isConvertSignatureEmpty()) {
        showMessage('Customer signature is required', 'error');
        return;
      }
      
      const token = localStorage.getItem('token');
      const fromType = document.getElementById('convert_original_type').value;
      const formId = document.getElementById('convert_original_id').value;
      const targetType = fromType === 'pickup' ? 'delivery' : 'pickup';
      
      const submitBtn = document.getElementById('convertSubmitBtn');
      submitBtn.disabled = true;
      const originalBtnText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="loading-spinner"></span>Converting...';
      
      // Use FormData to include signature
      const formData = new FormData();
      formData.append('from_type', fromType);
      formData.append('to_type', targetType);
      formData.append('form_id', parseInt(formId));
      
      // Add type-specific fields
      if (targetType === 'delivery') {
        formData.append('delivery_address', document.getElementById('convert_delivery_address').value);
        formData.append('delivery_cost', document.getElementById('convert_delivery_cost').value);
        formData.append('date_scheduled', formatDateForSubmission(document.getElementById('convert_date_scheduled').value));
      } else {
        const datePurchased = document.getElementById('convert_date_purchased').value;
        if (datePurchased) formData.append('date_purchased', formatDateForSubmission(datePurchased));
        formData.append('date_stored', formatDateForSubmission(document.getElementById('convert_date_stored').value));
      }
      
      // Add signature
      const blob = await new Promise(resolve => convertCanvas.toBlob(resolve, 'image/png'));
      formData.append('signature', blob, 'signature.png');
      
      try {
        const response = await fetch('/api/customer-forms-unified/convert', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
          let message = data.message;
          if (data.emailSent) {
            message += ' and email sent to customer!';
          } else if (data.emailError) {
            message += ` but email failed: ${data.emailError}`;
          }
          
          showMessage(message, data.emailSent ? 'success' : 'error');
          closeConvertModal();
          loadAllForms();
        } else {
          showMessage(data.error || 'Failed to convert form', 'error');
        }
      } catch (error) {
        console.error('Convert error:', error);
        showMessage('Network error. Please try again.', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
      }
    }
  </script>
</body>
</html>