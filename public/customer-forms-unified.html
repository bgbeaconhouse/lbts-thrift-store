<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LBTS - Customer Forms</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #00a0e0 0%, #1a2f5c 100%);
      color: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 { font-size: 24px; }

    .back-link {
      color: white;
      text-decoration: none;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .back-link:hover { text-decoration: underline; }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .top-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .form-type-selector {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-type-selector label {
      font-weight: 600;
      color: #2d3748;
    }

    .form-type-selector select {
      padding: 10px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      min-width: 150px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #00a0e0;
      color: white;
    }

    .btn-primary:hover {
      background: #00a0e0;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #718096;
      color: white;
      padding: 8px 16px;
      font-size: 13px;
    }

    .btn-secondary:hover { background: #4a5568; }

    .btn-danger {
      background: #f56565;
      color: white;
      padding: 6px 12px;
      font-size: 13px;
    }

    .btn-danger:hover { background: #e53e3e; }

    .btn-success {
      background: #48bb78;
      color: white;
      padding: 8px 16px;
      font-size: 13px;
    }

    .btn-success:hover { background: #38a169; }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .filter-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e2e8f0;
      overflow-x: auto;
    }

    .filter-tab {
      padding: 12px 24px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      color: #718096;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .filter-tab:hover { color: #2d3748; }

    .filter-tab.active {
      color: #00a0e0;
      border-bottom-color: #00a0e0;
    }

    .search-box {
      margin-bottom: 20px;
    }

    .search-box input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
    }

    .search-box input:focus {
      outline: none;
      border-color: #00a0e0;
    }

    .forms-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .form-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      transition: all 0.3s;
    }

    .form-card:hover {
      box-shadow: 0 5px 20px rgba(0,0,0,0.12);
    }

    .form-card.email-success {
      border-left: 4px solid #48bb78;
    }

    .form-card.email-failed {
      border-left: 4px solid #f56565;
    }

    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
      gap: 15px;
    }

    .form-info { flex: 1; }

    .customer-name {
      font-size: 18px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 5px;
    }

    .form-meta {
      color: #718096;
      font-size: 13px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .form-meta span {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-success {
      background: #48bb78;
      color: white;
    }

    .badge-warning {
      background: #f59e0b;
      color: white;
    }

    .badge-danger {
      background: #f56565;
      color: white;
    }

    .form-description {
      color: #4a5568;
      margin-top: 10px;
      line-height: 1.5;
    }

    .form-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .photos-preview {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .photo-thumb {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 5px;
      cursor: pointer;
      border: 2px solid #e2e8f0;
      transition: all 0.2s;
    }

    .photo-thumb:hover {
      border-color: #00a0e0;
      transform: scale(1.05);
    }

    .signature-preview {
      margin-top: 10px;
      padding: 10px;
      background: #f7fafc;
      border-radius: 5px;
      display: inline-block;
    }

    .signature-preview img {
      max-width: 200px;
      max-height: 80px;
      border: 1px solid #e2e8f0;
      border-radius: 3px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #718096;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .empty-state h3 {
      font-size: 20px;
      color: #2d3748;
      margin-bottom: 10px;
    }

    .empty-state p {
      font-size: 14px;
    }

    .message {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .message.success {
      background: #f0fff4;
      color: #22543d;
      border: 1px solid #9ae6b4;
    }

    .message.error {
      background: #fff5f5;
      color: #742a2a;
      border: 1px solid #fc8181;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: flex-start;
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 10px;
      width: 100%;
      max-width: 800px;
      margin: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .modal-header {
      padding: 25px;
      border-bottom: 2px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      color: #2d3748;
      font-size: 22px;
    }

    .close-modal {
      font-size: 28px;
      color: #718096;
      cursor: pointer;
      border: none;
      background: none;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .close-modal:hover {
      background: #f7fafc;
      color: #2d3748;
    }

    .modal-body {
      padding: 25px;
      max-height: calc(90vh - 150px);
      overflow-y: auto;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2d3748;
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #00a0e0;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    /* Signature Pad */
    .signature-pad {
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      background: white;
      margin-top: 10px;
    }

    .signature-canvas {
      width: 100%;
      height: 200px;
      touch-action: none;
      cursor: crosshair;
    }

    .signature-controls {
      padding: 10px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      justify-content: flex-end;
    }

    /* File Upload */
    .file-upload-area {
      border: 2px dashed #e2e8f0;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      background: #f7fafc;
      cursor: pointer;
      transition: all 0.2s;
    }

    .file-upload-area:hover {
      border-color: #00a0e0;
      background: #edf2f7;
    }

    .file-upload-area.dragover {
      border-color: #00a0e0;
      background: #ebf4ff;
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 10px;
      color: #cbd5e0;
    }

    .image-preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }

    .image-preview-item {
      position: relative;
      width: 100px;
      height: 100px;
    }

    .image-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 5px;
      border: 2px solid #e2e8f0;
    }

    .remove-image {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #f56565;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .remove-image:hover {
      background: #e53e3e;
    }

    /* Terms Boxes */
    .terms-box {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      font-size: 13px;
      line-height: 1.6;
      color: #856404;
    }

    .terms-box h4 {
      margin-bottom: 10px;
      font-size: 14px;
    }

    .terms-box ul {
      margin-left: 20px;
    }

    .terms-box li {
      margin-bottom: 5px;
    }

    .upload-status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      display: none;
    }

    .upload-status.active {
      display: block;
    }

    .upload-status.uploading {
      background: #ebf8ff;
      color: #2c5282;
      border: 1px solid #bee3f8;
    }

    .upload-status.success {
      background: #f0fff4;
      color: #22543d;
      border: 1px solid #9ae6b4;
    }

    /* Image Viewer Modal */
    .image-viewer-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .image-viewer-modal.active {
      display: flex;
    }

    .viewer-content {
      max-width: 90%;
      max-height: 90%;
      position: relative;
    }

    .viewer-main-image {
      max-width: 100%;
      max-height: 85vh;
      object-fit: contain;
    }

    .viewer-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      z-index: 10;
    }

    .viewer-close:hover {
      background: rgba(255,255,255,0.3);
    }

    .viewer-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
    }

    .viewer-nav:hover {
      background: rgba(255,255,255,0.3);
    }

    .viewer-nav-prev {
      left: 20px;
    }

    .viewer-nav-next {
      right: 20px;
    }

    .viewer-counter {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 14px;
    }

    .viewer-thumbnails {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .viewer-thumbnail {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 5px;
      cursor: pointer;
      border: 2px solid transparent;
      opacity: 0.6;
      transition: all 0.2s;
    }

    .viewer-thumbnail:hover {
      opacity: 1;
      border-color: white;
    }

    .viewer-thumbnail.active {
      opacity: 1;
      border-color: #00a0e0;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1>üìã Customer Forms</h1>
      <a href="/dashboard.html" class="back-link">‚Üê Back to Dashboard</a>
    </div>
  </div>

  <div class="container">
    <div id="message" class="message"></div>

    <!-- Top Controls -->
    <div class="top-controls">
      <div class="form-type-selector">
        <label for="formTypeSelect">Form Type:</label>
        <select id="formTypeSelect" onchange="handleDropdownChange()">
          <option value="pickup">Pick-Up</option>
          <option value="delivery">Delivery</option>
          <option value="donation">Donation</option>
          <option value="waiver">Waiver</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="openCreateModal()">+ New Form</button>
    </div>

    <!-- Filter Tabs -->
    <div class="filter-tabs">
      <button class="filter-tab active" data-filter="pickup" onclick="setFilter('pickup')">Pick-Up</button>
      <button class="filter-tab" data-filter="delivery" onclick="setFilter('delivery')">Delivery</button>
      <button class="filter-tab" data-filter="donation" onclick="setFilter('donation')">Donation</button>
      <button class="filter-tab" data-filter="waiver" onclick="setFilter('waiver')">Waiver</button>
    </div>

    <!-- Search Box -->
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search by customer name, phone, or email..." oninput="filterForms()">
    </div>

    <!-- Forms List -->
    <div id="formsList" class="forms-list"></div>
  </div>

  <!-- Create/Edit Form Modal -->
  <div id="formModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">New Form</h2>
        <button class="close-modal" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="customerForm" onsubmit="handleSubmit(event)">
          <!-- Customer Info -->
          <div class="form-row">
            <div class="form-group">
              <label for="customer_name">Customer Name *</label>
              <input type="text" id="customer_name" required>
            </div>
            <div class="form-group">
              <label for="phone">Phone *</label>
              <input type="tel" id="phone" required>
            </div>
          </div>

          <div class="form-group">
            <label for="email">Email (for receipt)</label>
            <input type="email" id="email">
          </div>

          <!-- Pickup-specific fields -->
          <div id="pickupFields" style="display: none;">
            <div class="form-row">
              <div class="form-group">
                <label for="date_purchased">Date Purchased</label>
                <input type="date" id="date_purchased">
              </div>
              <div class="form-group">
                <label for="date_stored">Pick-Up Date *</label>
                <input type="date" id="date_stored">
              </div>
            </div>

            <div class="form-group">
              <label for="items_description_pickup">Items Description</label>
              <textarea id="items_description_pickup"></textarea>
            </div>

            <div class="form-group">
              <label>Photos (optional)</label>
              <input type="file" id="pictures_pickup" accept="image/*" multiple style="display: none;" onchange="handleFileSelect(event)">
              <div class="file-upload-area" onclick="document.getElementById('pictures_pickup').click()">
                <div class="upload-icon">üì∑</div>
                <p>Click to upload photos or drag and drop</p>
                <small>Up to 10 images</small>
              </div>
              <div id="imagePreviews_pickup" class="image-preview-container"></div>
            </div>

            <!-- Pickup Terms -->
            <div class="terms-box">
              <h4>‚ö†Ô∏è Pick-Up Terms & Conditions</h4>
              <p>You have <strong>48 hours upon purchase</strong> to pick your item up. After 48 hours the item will be placed back on the sales floor and <strong>no refunds will be issued</strong>.</p>
              <p style="margin-top: 10px;">We will gladly assist you in loading your items. Please be aware that it is the customer's responsibility to ensure items are properly loaded and secured.</p>
            </div>
          </div>

          <!-- Delivery-specific fields -->
          <div id="deliveryFields" style="display: none;">
            <div class="form-group">
              <label for="delivery_address">Delivery Address *</label>
              <textarea id="delivery_address" rows="3"></textarea>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="delivery_cost">Delivery Cost *</label>
                <input type="number" id="delivery_cost" step="0.01" min="0">
              </div>
              <div class="form-group">
                <label for="date_scheduled">Delivery Date *</label>
                <input type="date" id="date_scheduled">
              </div>
            </div>

            <div class="form-group">
              <label for="items_description_delivery">Items Description</label>
              <textarea id="items_description_delivery"></textarea>
            </div>

            <div class="form-group">
              <label>Photos (optional)</label>
              <input type="file" id="pictures_delivery" accept="image/*" multiple style="display: none;" onchange="handleFileSelect(event)">
              <div class="file-upload-area" onclick="document.getElementById('pictures_delivery').click()">
                <div class="upload-icon">üì∑</div>
                <p>Click to upload photos or drag and drop</p>
                <small>Up to 10 images</small>
              </div>
              <div id="imagePreviews_delivery" class="image-preview-container"></div>
            </div>

            <!-- Delivery Terms -->
            <div class="terms-box">
              <h4>‚ö†Ô∏è Delivery Information</h4>
              <p>I hereby acknowledge that my payment shown above is solely for the delivery of the item(s) to the residence indicated at the time of purchase. The Beacon House Thrift Shop is not responsible for moving said item(s) into said residence due to issues with liability. The item(s) will be placed in the driveway or the front yard.</p>
            </div>
          </div>

          <!-- Donation-specific fields -->
          <div id="donationFields" style="display: none;">
            <div class="form-group">
              <label for="donation_description">Donation Description</label>
              <textarea id="donation_description"></textarea>
            </div>
          </div>

          <!-- Waiver doesn't need extra fields beyond customer info -->

          <!-- Customer Signature (all forms) -->
          <div id="signatureSection" class="form-group">
            <label>Customer Signature</label>
            <div class="signature-pad">
              <canvas id="signatureCanvas" class="signature-canvas"></canvas>
              <div class="signature-controls">
                <button type="button" class="btn btn-secondary" onclick="clearSignature()">Clear</button>
              </div>
            </div>
            <div id="signatureStatus" class="upload-status"></div>
          </div>

          <!-- Manager Signature (waiver only) -->
          <div id="managerSignatureSection" class="form-group" style="display: none;">
            <label>Manager Signature</label>
            <div class="signature-pad">
              <canvas id="managerSignatureCanvas" class="signature-canvas"></canvas>
              <div class="signature-controls">
                <button type="button" class="btn btn-secondary" onclick="clearManagerSignature()">Clear</button>
              </div>
            </div>
            <div id="managerSignatureStatus" class="upload-status"></div>
          </div>

          <button type="submit" id="submitBtn" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
            Create Form
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Image Viewer Modal -->
  <div id="imageViewerModal" class="image-viewer-modal" onclick="closeImageViewer(event)">
    <button class="viewer-close" onclick="closeImageViewer(event)">&times;</button>
    <button class="viewer-nav viewer-nav-prev" onclick="viewerPrevImage(event)">‚Äπ</button>
    <button class="viewer-nav viewer-nav-next" onclick="viewerNextImage(event)">‚Ä∫</button>
    <div class="viewer-content" onclick="event.stopPropagation()">
      <img id="viewerMainImage" class="viewer-main-image" src="" alt="Full size image">
      <div class="viewer-counter" id="viewerCounter">1 / 1</div>
      <div id="viewerThumbnails" class="viewer-thumbnails"></div>
    </div>
  </div>

  <script>
    // Global state
    let allForms = [];
    let currentFilter = 'pickup';
    let selectedFiles = [];
    let isSubmitting = false;
    
    // Signature pad setup
    let canvas, ctx, isDrawing = false;
    let managerCanvas, managerCtx, isDrawingManager = false;

    // Image viewer
    let viewerImages = [];
    let currentViewerIndex = 0;
    let touchStartX = 0;
    let touchEndX = 0;

    // Initialize on page load
    window.onload = () => {
      checkAuth();
      loadAllForms();
      initSignaturePad();
      initManagerSignaturePad();
    };

    function checkAuth() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/';
        return;
      }
    }

    // Load all forms
    async function loadAllForms() {
      const token = localStorage.getItem('token');
      const types = ['pickup', 'delivery', 'donation', 'waiver'];
      
      allForms = [];
      
      for (const type of types) {
        try {
          const response = await fetch(`/api/customer-forms-unified/${type}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (response.ok) {
            const data = await response.json();
            // Add type to each form for filtering
            const formsWithType = data.forms.map(form => ({ ...form, form_type: type }));
            allForms = allForms.concat(formsWithType);
          }
        } catch (error) {
          console.error(`Error loading ${type} forms:`, error);
        }
      }
      
      // Sort by created_at desc
      allForms.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      
      filterForms();
    }

    // Set filter
    function setFilter(filter) {
      currentFilter = filter;
      
      // Update active tab
      document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.filter === filter) {
          tab.classList.add('active');
        }
      });
      
      // Update dropdown to match the filter
      document.getElementById('formTypeSelect').value = filter;
      
      filterForms();
    }

    // Handle dropdown change - sync tabs with dropdown selection
    function handleDropdownChange() {
      const selectedType = document.getElementById('formTypeSelect').value;
      setFilter(selectedType);
    }

    // Filter and display forms
    function filterForms() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      let filtered = allForms;
      
      // Filter by type (always filter since we removed 'all')
      filtered = filtered.filter(form => form.form_type === currentFilter);
      
      // Filter by search term
      if (searchTerm) {
        filtered = filtered.filter(form => 
          form.customer_name.toLowerCase().includes(searchTerm) ||
          (form.phone && form.phone.toLowerCase().includes(searchTerm)) ||
          (form.email && form.email.toLowerCase().includes(searchTerm))
        );
      }
      
      displayForms(filtered);
    }

    // Display forms
    function displayForms(forms) {
      const list = document.getElementById('formsList');
      
      if (forms.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <h3>No forms found</h3>
            <p>Create your first form using the "New Form" button above</p>
          </div>
        `;
        return;
      }
      
      list.innerHTML = forms.map(form => {
        const emailClass = form.email_sent ? 'email-success' : (form.email_error ? 'email-failed' : '');
        const emailBadge = form.email_sent 
          ? '<span class="badge badge-success">‚úì Email Sent</span>'
          : form.email_error 
          ? '<span class="badge badge-danger">‚úó Email Failed</span>'
          : form.email 
          ? '<span class="badge badge-warning">‚è≥ No Email</span>'
          : '<span class="badge badge-warning">No Email Address</span>';
        
        const typeLabel = form.form_type.charAt(0).toUpperCase() + form.form_type.slice(1);
        
        let description = '';
        if (form.form_type === 'donation') {
          description = form.donation_description;
        } else if (form.form_type !== 'waiver') {
          description = form.items_description || form.notes;
        }
        
        const hasPhotos = form.picture_urls && form.picture_urls.length > 0;
        
        return `
          <div class="form-card ${emailClass}">
            <div class="form-header">
              <div class="form-info">
                <div class="customer-name">${escapeHtml(form.customer_name)}</div>
                <div class="form-meta">
                  <span><strong>${typeLabel}</strong></span>
                  <span>üìû ${escapeHtml(form.phone)}</span>
                  ${form.email ? `<span>üìß ${escapeHtml(form.email)}</span>` : ''}
                  <span>üìÖ ${new Date(form.created_at).toLocaleDateString()}</span>
                  ${form.delivery_cost ? `<span>üíµ $${parseFloat(form.delivery_cost).toFixed(2)}</span>` : ''}
                  ${form.date_scheduled || form.date_stored ? `<span>üóìÔ∏è ${new Date(form.date_scheduled || form.date_stored).toLocaleDateString()}</span>` : ''}
                  <span>${emailBadge}</span>
                </div>
                ${description ? `<div class="form-description">${escapeHtml(description).substring(0, 150)}${description.length > 150 ? '...' : ''}</div>` : ''}
                ${hasPhotos ? `
                  <div class="photos-preview">
                    ${form.picture_urls.slice(0, 5).map(url => `
                      <img src="${url}" alt="Item photo" class="photo-thumb" onclick="openImageViewer(${JSON.stringify(form.picture_urls).replace(/"/g, '&quot;')})">
                    `).join('')}
                    ${form.picture_urls.length > 5 ? `<div style="font-size: 12px; color: #718096; display: flex; align-items: center;">+${form.picture_urls.length - 5} more</div>` : ''}
                  </div>
                ` : ''}
                ${form.signature_url ? `
                  <div class="signature-preview">
                    <div style="font-size: 12px; color: #718096; margin-bottom: 5px;">Customer Signature:</div>
                    <img src="${form.signature_url}" alt="Signature">
                  </div>
                ` : ''}
              </div>
              <div class="form-actions">
                ${form.email && form.email_error ? `
                  <button class="btn btn-success" onclick="retryEmail('${form.form_type}', ${form.id})">Retry Email</button>
                ` : ''}
                <button class="btn btn-danger" onclick="deleteForm('${form.form_type}', ${form.id})">Delete</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Open create modal
    function openCreateModal() {
      const formType = document.getElementById('formTypeSelect').value;
      const typeNames = {
        pickup: 'Pick-Up',
        delivery: 'Delivery',
        donation: 'Donation',
        waiver: 'Waiver'
      };
      
      document.getElementById('modalTitle').textContent = `New ${typeNames[formType]} Form`;
      document.getElementById('customerForm').reset();
      clearSignature();
      clearManagerSignature();
      selectedFiles = [];
      
      // Show/hide fields based on form type
      document.getElementById('pickupFields').style.display = formType === 'pickup' ? 'block' : 'none';
      document.getElementById('deliveryFields').style.display = formType === 'delivery' ? 'block' : 'none';
      document.getElementById('donationFields').style.display = formType === 'donation' ? 'block' : 'none';
      document.getElementById('managerSignatureSection').style.display = formType === 'waiver' ? 'block' : 'none';
      
      // Clear image previews
      document.getElementById('imagePreviews_pickup').innerHTML = '';
      document.getElementById('imagePreviews_delivery').innerHTML = '';
      
      document.getElementById('formModal').classList.add('active');
      
      // Re-initialize canvas after modal is visible
      setTimeout(() => {
        initSignaturePad();
        initManagerSignaturePad();
      }, 100);
    }

    function closeModal() {
      document.getElementById('formModal').classList.remove('active');
      document.getElementById('customerForm').reset();
      selectedFiles = [];
      isSubmitting = false;
    }

    // Initialize signature pad
    function initSignaturePad() {
      canvas = document.getElementById('signatureCanvas');
      if (!canvas) return;
      
      ctx = canvas.getContext('2d');
      
      // Set canvas size
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
      
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      
      // Mouse events
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);
      
      // Touch events
      canvas.addEventListener('touchstart', handleTouchStart);
      canvas.addEventListener('touchmove', handleTouchMove);
      canvas.addEventListener('touchend', stopDrawing);
    }

    function initManagerSignaturePad() {
      managerCanvas = document.getElementById('managerSignatureCanvas');
      if (!managerCanvas) return;
      
      managerCtx = managerCanvas.getContext('2d');
      
      const rect = managerCanvas.getBoundingClientRect();
      managerCanvas.width = rect.width;
      managerCanvas.height = rect.height;
      
      managerCtx.strokeStyle = '#000';
      managerCtx.lineWidth = 2;
      managerCtx.lineCap = 'round';
      
      managerCanvas.addEventListener('mousedown', (e) => startDrawing(e, true));
      managerCanvas.addEventListener('mousemove', (e) => draw(e, true));
      managerCanvas.addEventListener('mouseup', stopDrawing);
      managerCanvas.addEventListener('mouseout', stopDrawing);
      
      managerCanvas.addEventListener('touchstart', (e) => handleTouchStart(e, true));
      managerCanvas.addEventListener('touchmove', (e) => handleTouchMove(e, true));
      managerCanvas.addEventListener('touchend', stopDrawing);
    }

    function startDrawing(e, isManager = false) {
      if (isManager) {
        isDrawingManager = true;
        const rect = managerCanvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        managerCtx.beginPath();
        managerCtx.moveTo(x, y);
      } else {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        ctx.beginPath();
        ctx.moveTo(x, y);
      }
    }

    function draw(e, isManager = false) {
      if (isManager && !isDrawingManager) return;
      if (!isManager && !isDrawing) return;
      
      const targetCanvas = isManager ? managerCanvas : canvas;
      const targetCtx = isManager ? managerCtx : ctx;
      
      const rect = targetCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      targetCtx.lineTo(x, y);
      targetCtx.stroke();
    }

    function stopDrawing() {
      isDrawing = false;
      isDrawingManager = false;
    }

    function handleTouchStart(e, isManager = false) {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousedown', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      if (isManager) {
        managerCanvas.dispatchEvent(mouseEvent);
      } else {
        canvas.dispatchEvent(mouseEvent);
      }
    }

    function handleTouchMove(e, isManager = false) {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      if (isManager) {
        managerCanvas.dispatchEvent(mouseEvent);
      } else {
        canvas.dispatchEvent(mouseEvent);
      }
    }

    function clearSignature() {
      if (ctx && canvas) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
    }

    function clearManagerSignature() {
      if (managerCtx && managerCanvas) {
        managerCtx.clearRect(0, 0, managerCanvas.width, managerCanvas.height);
      }
    }

    function isSignatureEmpty() {
      if (!canvas || !ctx) return true;
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      return !imageData.data.some(channel => channel !== 0);
    }

    function isManagerSignatureEmpty() {
      if (!managerCanvas || !managerCtx) return true;
      const imageData = managerCtx.getImageData(0, 0, managerCanvas.width, managerCanvas.height);
      return !imageData.data.some(channel => channel !== 0);
    }

    // File handling
    async function handleFileSelect(event) {
      const files = Array.from(event.target.files);
      const formType = document.getElementById('formTypeSelect').value;
      
      if (files.length > 10) {
        showMessage('Maximum 10 images allowed', 'error');
        return;
      }
      
      selectedFiles = [];
      const previewContainer = document.getElementById(`imagePreviews_${formType}`);
      previewContainer.innerHTML = '';
      
      for (const file of files) {
        // Compress image
        const compressed = await compressImage(file);
        selectedFiles.push(compressed);
        
        // Show preview
        const reader = new FileReader();
        reader.onload = (e) => {
          const div = document.createElement('div');
          div.className = 'image-preview-item';
          div.innerHTML = `
            <img src="${e.target.result}" alt="Preview">
            <button type="button" class="remove-image" onclick="removeImage(${selectedFiles.length - 1}, '${formType}')">&times;</button>
          `;
          previewContainer.appendChild(div);
        };
        reader.readAsDataURL(compressed);
      }
    }

    async function compressImage(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            const maxDimension = 1920;
            if (width > height && width > maxDimension) {
              height = (height * maxDimension) / width;
              width = maxDimension;
            } else if (height > maxDimension) {
              width = (width * maxDimension) / height;
              height = maxDimension;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            canvas.toBlob((blob) => {
              resolve(new File([blob], file.name, { type: 'image/jpeg' }));
            }, 'image/jpeg', 0.85);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    function removeImage(index, formType) {
      selectedFiles.splice(index, 1);
      const input = document.getElementById(`pictures_${formType}`);
      input.value = '';
      
      // Refresh preview
      const previewContainer = document.getElementById(`imagePreviews_${formType}`);
      previewContainer.innerHTML = '';
      
      selectedFiles.forEach((file, idx) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const div = document.createElement('div');
          div.className = 'image-preview-item';
          div.innerHTML = `
            <img src="${e.target.result}" alt="Preview">
            <button type="button" class="remove-image" onclick="removeImage(${idx}, '${formType}')">&times;</button>
          `;
          previewContainer.appendChild(div);
        };
        reader.readAsDataURL(file);
      });
    }

    // Form submission
    async function handleSubmit(event) {
      event.preventDefault();
      
      if (isSubmitting) {
        console.log('Form already submitting...');
        return;
      }
      
      const token = localStorage.getItem('token');
      const formType = document.getElementById('formTypeSelect').value;
      const submitBtn = document.getElementById('submitBtn');
      
      isSubmitting = true;
      submitBtn.disabled = true;
      const originalBtnText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="loading-spinner"></span>Submitting...';
      
      const formData = new FormData();
      formData.append('form_type', formType);
      formData.append('customer_name', document.getElementById('customer_name').value);
      formData.append('phone', document.getElementById('phone').value);
      formData.append('email', document.getElementById('email').value);
      
      // Add type-specific fields
      if (formType === 'pickup') {
        const datePurchased = document.getElementById('date_purchased').value;
        const dateStored = document.getElementById('date_stored').value;
        const description = document.getElementById('items_description_pickup').value;
        
        if (datePurchased) formData.append('date_purchased', datePurchased);
        if (dateStored) formData.append('date_stored', dateStored);
        if (description) formData.append('items_description', description);
        
        // Add photos
        selectedFiles.forEach(file => {
          formData.append('pictures', file);
        });
        
      } else if (formType === 'delivery') {
        const address = document.getElementById('delivery_address').value;
        const cost = document.getElementById('delivery_cost').value;
        const dateScheduled = document.getElementById('date_scheduled').value;
        const description = document.getElementById('items_description_delivery').value;
        
        if (address) formData.append('delivery_address', address);
        if (cost) formData.append('delivery_cost', cost);
        if (dateScheduled) formData.append('date_scheduled', dateScheduled);
        if (description) formData.append('items_description', description);
        
        // Add photos
        selectedFiles.forEach(file => {
          formData.append('pictures', file);
        });
        
      } else if (formType === 'donation') {
        const description = document.getElementById('donation_description').value;
        if (description) formData.append('donation_description', description);
      }
      
      // Add signatures
      if (!isSignatureEmpty()) {
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        formData.append('signature', blob, 'signature.png');
      }
      
      if (formType === 'waiver' && !isManagerSignatureEmpty()) {
        const blob = await new Promise(resolve => managerCanvas.toBlob(resolve, 'image/png'));
        formData.append('manager_signature', blob, 'manager_signature.png');
      }
      
      try {
        const response = await fetch('/api/customer-forms-unified/create', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
          let message = data.message;
          if (data.emailSent) {
            message += ' and email sent to customer!';
          } else if (data.emailError) {
            message += ` but email failed: ${data.emailError}`;
          } else if (!data.form.email) {
            message += ' (no email address provided)';
          }
          
          showMessage(message, data.emailSent ? 'success' : 'error');
          closeModal();
          loadAllForms();
        } else {
          showMessage(data.error || 'Failed to create form', 'error');
        }
      } catch (error) {
        console.error('Submit error:', error);
        showMessage('Network error. Please try again.', 'error');
      } finally {
        isSubmitting = false;
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
      }
    }

    // Retry email
    async function retryEmail(type, id) {
      const token = localStorage.getItem('token');
      
      try {
        const response = await fetch(`/api/customer-forms-unified/retry-email/${type}/${id}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showMessage('Email sent successfully!', 'success');
          loadAllForms();
        } else {
          showMessage(data.error || 'Failed to send email', 'error');
        }
      } catch (error) {
        console.error('Retry email error:', error);
        showMessage('Network error. Please try again.', 'error');
      }
    }

    // Delete form
    async function deleteForm(type, id) {
      if (!confirm('Are you sure you want to delete this form?')) {
        return;
      }
      
      const token = localStorage.getItem('token');
      
      try {
        const response = await fetch(`/api/customer-forms-unified/${type}/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showMessage(data.message, 'success');
          loadAllForms();
        } else {
          showMessage(data.error || 'Delete failed', 'error');
        }
      } catch (error) {
        console.error('Delete error:', error);
        showMessage('Network error. Please try again.', 'error');
      }
    }

    // Image viewer
    function openImageViewer(images) {
      viewerImages = images;
      currentViewerIndex = 0;
      showViewerImage(0);
      document.getElementById('imageViewerModal').classList.add('active');
      document.body.style.overflow = 'hidden';
      
      const mainImage = document.getElementById('viewerMainImage');
      mainImage.addEventListener('touchstart', handleViewerTouchStart, { passive: true });
      mainImage.addEventListener('touchend', handleViewerTouchEnd, { passive: true });
    }

    function closeImageViewer(event) {
      if (event && event.target !== event.currentTarget && !event.target.classList.contains('viewer-close')) {
        return;
      }
      document.getElementById('imageViewerModal').classList.remove('active');
      document.body.style.overflow = '';
      
      const mainImage = document.getElementById('viewerMainImage');
      mainImage.removeEventListener('touchstart', handleViewerTouchStart);
      mainImage.removeEventListener('touchend', handleViewerTouchEnd);
    }

    function showViewerImage(index) {
      if (viewerImages.length === 0) return;
      
      currentViewerIndex = index;
      const mainImage = document.getElementById('viewerMainImage');
      const counter = document.getElementById('viewerCounter');
      const thumbnailsContainer = document.getElementById('viewerThumbnails');
      
      mainImage.src = viewerImages[index];
      counter.textContent = `${index + 1} / ${viewerImages.length}`;
      
      thumbnailsContainer.innerHTML = viewerImages.map((url, i) => `
        <img src="${url}" 
             class="viewer-thumbnail ${i === index ? 'active' : ''}" 
             onclick="showViewerImage(${i})"
             alt="Thumbnail ${i + 1}">
      `).join('');
    }

    function viewerPrevImage(event) {
      event.stopPropagation();
      const newIndex = currentViewerIndex > 0 ? currentViewerIndex - 1 : viewerImages.length - 1;
      showViewerImage(newIndex);
    }

    function viewerNextImage(event) {
      event.stopPropagation();
      const newIndex = currentViewerIndex < viewerImages.length - 1 ? currentViewerIndex + 1 : 0;
      showViewerImage(newIndex);
    }

    function handleViewerTouchStart(event) {
      touchStartX = event.changedTouches[0].screenX;
    }

    function handleViewerTouchEnd(event) {
      touchEndX = event.changedTouches[0].screenX;
      const diff = touchStartX - touchEndX;
      const swipeThreshold = 50;
      
      if (Math.abs(diff) > swipeThreshold) {
        if (diff > 0) {
          viewerNextImage({ stopPropagation: () => {} });
        } else {
          viewerPrevImage({ stopPropagation: () => {} });
        }
      }
    }

    // Keyboard navigation
    document.addEventListener('keydown', function(event) {
      const modal = document.getElementById('imageViewerModal');
      if (!modal.classList.contains('active')) return;
      
      if (event.key === 'Escape') {
        closeImageViewer();
      } else if (event.key === 'ArrowLeft') {
        viewerPrevImage(event);
      } else if (event.key === 'ArrowRight') {
        viewerNextImage(event);
      }
    });

    // Utility functions
    function showMessage(text, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = text;
      messageDiv.className = `message ${type}`;
      messageDiv.style.display = 'block';
      
      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 5000);
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>