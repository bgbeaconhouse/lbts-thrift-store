<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LBTS - Customer Forms</title>
  <script src="/storage-fallback.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
    }

    .back-link {
      color: white;
      text-decoration: none;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    /* Container */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    /* Form Type Tabs */
    .form-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e2e8f0;
      overflow-x: auto;
    }

    .form-tab {
      padding: 12px 24px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      color: #718096;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .form-tab:hover {
      color: #2d3748;
    }

    .form-tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    /* Top Bar */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: #f56565;
      color: white;
      padding: 6px 12px;
      font-size: 13px;
    }

    .btn-danger:hover {
      background: #e53e3e;
    }

    .btn-secondary {
      background: #718096;
      color: white;
      padding: 8px 16px;
      font-size: 13px;
    }

    .btn-secondary:hover {
      background: #4a5568;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Loading Spinner */
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .signature-status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      display: none;
    }

    .signature-status.active {
      display: block;
    }

    .signature-status.processing {
      background: #ebf8ff;
      color: #2c5282;
      border: 1px solid #bee3f8;
    }

    .signature-status.success {
      background: #f0fff4;
      color: #22543d;
      border: 1px solid #9ae6b4;
    }

    /* Forms List */
    .forms-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .form-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      transition: all 0.3s;
    }

    .form-card:hover {
      box-shadow: 0 5px 20px rgba(0,0,0,0.12);
    }

    .form-card.emailed {
      background: #f0fdf4;
      border-left: 4px solid #48bb78;
    }

    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
      gap: 15px;
    }

    .form-info {
      flex: 1;
    }

    .customer-name {
      font-size: 18px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 5px;
    }

    .form-meta {
      color: #718096;
      font-size: 13px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .form-meta span {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .emailed-badge {
      display: inline-block;
      padding: 4px 10px;
      background: #48bb78;
      color: white;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .pending-badge {
      display: inline-block;
      padding: 4px 10px;
      background: #f59e0b;
      color: white;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .form-description {
      color: #4a5568;
      margin-top: 10px;
      line-height: 1.5;
    }

    .signature-preview {
      margin-top: 10px;
      padding: 10px;
      background: #f7fafc;
      border-radius: 5px;
      display: inline-block;
    }

    .signature-preview img {
      max-width: 200px;
      max-height: 80px;
      border: 1px solid #e2e8f0;
      border-radius: 3px;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      overflow-y: auto;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 600px;
      margin: 20px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h2 {
      color: #2d3748;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #a0aec0;
    }

    .close-btn:hover {
      color: #4a5568;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #2d3748;
      font-weight: 500;
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #e2e8f0;
      border-radius: 5px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    /* Signature Pad */
    .signature-section {
      margin-bottom: 20px;
    }

    .signature-pad-container {
      border: 2px solid #e2e8f0;
      border-radius: 5px;
      background: white;
      margin-top: 10px;
    }

    .signature-canvas {
      width: 100%;
      height: 200px;
      cursor: crosshair;
      touch-action: none;
    }

    .signature-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .message {
      padding: 12px;
      border-radius: 5px;
      margin-bottom: 20px;
      display: none;
    }

    .message.success {
      background: #c6f6d5;
      color: #22543d;
      border: 1px solid #9ae6b4;
      display: block;
    }

    .message.error {
      background: #fed7d7;
      color: #742a2a;
      border: 1px solid #fc8181;
      display: block;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: 10px;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .empty-state h3 {
      color: #2d3748;
      margin-bottom: 10px;
    }

    .empty-state p {
      color: #718096;
      margin-bottom: 20px;
    }

    .info-box {
      background: #e0e7ff;
      border: 1px solid #c7d2fe;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 20px;
      color: #3730a3;
      font-size: 14px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 10px;
      }

      .top-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .form-header {
        flex-direction: column;
      }

      .form-meta {
        flex-direction: column;
        gap: 5px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <h1>üìã Customer Forms</h1>
      <a href="/dashboard.html" class="back-link">‚Üê Back to Dashboard</a>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">
    <div id="message" class="message"></div>

  <!-- Form Type Tabs -->
<div class="form-tabs">
  <button class="form-tab active" data-type="pickup" onclick="switchFormType('pickup')">
    üì¶ Pick-Up Forms
  </button>
  <button class="form-tab" data-type="delivery" onclick="switchFormType('delivery')">
    üöö Delivery Forms
  </button>
  <button class="form-tab" data-type="donation" onclick="switchFormType('donation')">
    üéÅ Donation Forms
  </button>
  <button class="form-tab" data-type="waiver" onclick="switchFormType('waiver')">
    üìù Waiver Forms
  </button>
</div>

    <!-- Top Bar -->
    <div class="top-bar">
      <h2 style="color: #2d3748;" id="formTitle">Pick-Up Forms</h2>
      <button class="btn btn-primary" onclick="openCreateModal()">+ New Form</button>
    </div>

    <!-- Forms List -->
    <div class="forms-list" id="formsList">
      <div style="text-align: center; padding: 40px; background: white; border-radius: 10px;">
        Loading forms...
      </div>
    </div>
  </div>

  <!-- Create Form Modal -->
  <div id="formModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">New Pick-Up Form</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>

      <div class="info-box">
        ‚ÑπÔ∏è This form will be saved locally and can be emailed to the customer later using the "Send Emails" feature.
      </div>

      <form id="customerForm" onsubmit="handleSubmit(event)">
        <div class="form-group">
          <label for="customer_name">Customer Name *</label>
          <input type="text" id="customer_name" required placeholder="John Doe">
        </div>

        <div class="form-group">
          <label for="phone">Phone Number *</label>
          <input type="tel" id="phone" required placeholder="(555) 123-4567">
        </div>

        <div class="form-group">
          <label for="email">Email (for receipt)</label>
          <input type="email" id="email" placeholder="customer@example.com">
        </div>

<div class="form-group" id="descriptionGroup">
  <label for="description" id="descriptionLabel">Items Description</label>
  <textarea id="description" placeholder="List of items..."></textarea>
</div>

<div class="form-group" id="deliveryCostGroup" style="display: none;">
  <label for="delivery_cost">Delivery Cost *</label>
  <input type="number" id="delivery_cost" step="0.01" min="0" placeholder="0.00">
</div>

<div class="form-group" id="deliveryDateGroup" style="display: none;">
  <label for="delivery_date">Delivery Date</label>
  <input type="text" id="delivery_date" placeholder="e.g., Monday 10/28, Next week, etc.">
</div>

<div class="signature-section">
  <!-- Pick-Up Terms -->
  <div id="pickupTermsBox" style="display: none; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 20px; margin-bottom: 20px; color: #856404;">
    <h3 style="margin-top: 0; color: #856404;">‚ö†Ô∏è Terms and Conditions</h3>
    <p style="line-height: 1.8; margin-bottom: 15px;">
      You are agreeing you understand you have <strong>48 hours upon purchase</strong> to pick your item up. 
      After 48 hours the item will be placed back on the sales floor and <strong>no refunds will be issued</strong>.
    </p>
    <p style="line-height: 1.8; margin-bottom: 15px;">
      We will gladly assist you in loading your items. Please be aware that it is the customer's responsibility 
      to ensure items are properly loaded and secured. We are not responsible for any damage caused by loading 
      or failure to secure items.
    </p>
    <p style="line-height: 1.8; margin: 0; font-weight: bold;">
      Your signature below acknowledges that you have read and understand the terms and conditions covered above.
    </p>
  </div>
  
  <!-- Delivery Terms -->
  <div id="deliveryTermsBox" style="display: none; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 20px; margin-bottom: 20px; color: #856404;">
    <h3 style="margin-top: 0; color: #856404;">‚ö†Ô∏è Terms and Conditions</h3>
    <p style="line-height: 1.8; margin: 0;">
      By signing below I hereby acknowledge that cost of delivery is solely for the delivery of the item(s) 
      to the residence indicated at the time of purchase. The Beacon House Thrift Shop is not responsible 
      for moving said item(s) into said residence due to issues with liability. The item(s) will be placed 
      in the driveway or the front yard.
    </p>
  </div>

  <!-- Waiver Terms -->
<div id="waiverTermsBox" style="display: none; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 20px; margin-bottom: 20px; color: #856404; max-height: 400px; overflow-y: auto;">
  <h3 style="margin-top: 0; color: #856404;">üìù Release of Liability Form for Loading Purchased Furniture</h3>
  
  <p style="line-height: 1.8; margin-bottom: 15px;">
    I hereby acknowledge and agree to the following terms and conditions when The Beacon House Association of San Pedro employees load furniture into my vehicle:
  </p>
  
  <ul style="line-height: 1.8; margin-left: 20px; margin-bottom: 15px;">
    <li><strong>Acknowledgment of Voluntary Participation:</strong> I understand that the loading of furniture into my vehicle is a voluntary service offered by The Beacon House Association of San Pedro, and I choose to participate in this service willingly.</li>
    
    <li><strong>Release and Waiver of Liability:</strong> In consideration of The Beacon House Association of San Pedro providing assistance in loading furniture into my vehicle, I hereby release, waive, and discharge The Beacon House Association of San Pedro and its employees, agents, volunteers, and representatives from any and all claims, liabilities, demands, actions, and causes of action whatsoever, arising out of or related to any loss, damage, or injury that may occur during the loading process.</li>
    
    <li><strong>Assumption of Risks:</strong> I acknowledge that loading furniture into my vehicle involves certain risks, including but not limited to the risk of bodily injury, property damage, or other harm. I voluntarily assume all risks associated with this service.</li>
    
    <li><strong>Care and Supervision:</strong> I understand that the employees of The Beacon House Association of San Pedro will exercise reasonable care and caution during the loading process. However, I am solely responsible for ensuring that my vehicle is suitable for loading furniture, and I will provide any necessary instructions to the loading staff.</li>
    
    <li><strong>Indemnification:</strong> I agree to indemnify and hold harmless The Beacon House Association of San Pedro, its employees, agents, volunteers, and representatives from any claims, actions, damages, liabilities, or expenses, including attorney fees, arising out of my use of the loading service or any injury or damage resulting from the loading process.</li>
    
    <li><strong>Vehicle Inspection:</strong> I agree to have my vehicle inspected before the furniture is loaded to ensure it is in a safe and suitable condition to transport the furniture.</li>
    
    <li><strong>Personal Property Responsibility:</strong> I understand that any personal belongings left in my vehicle during the loading process are my responsibility. The Beacon House Association of San Pedro and its employees shall not be liable for any loss or damage to personal property.</li>
    
    <li><strong>Compliance with Instructions:</strong> I agree to follow all instructions provided by The Beacon House Association of San Pedro employees during the loading process for the safety of all parties involved.</li>
  </ul>
  
  <p style="line-height: 1.8; margin-bottom: 20px; font-weight: bold;">
    I have read and understood this Release of Liability Form, and I voluntarily sign it with my signature below.
  </p>
  
  <div style="background: #e8f4f8; border: 2px solid #4299e1; border-radius: 8px; padding: 15px; margin-top: 20px;">
    <h4 style="margin-top: 0; color: #2c5282;">Acknowledgment Summary:</h4>
    <p style="line-height: 1.6; margin-bottom: 10px;">
      By signing this form, you have acknowledged and agreed to the following:
    </p>
    <ul style="line-height: 1.6; margin-left: 20px; margin-bottom: 0;">
      <li><strong>Voluntary Participation:</strong> The loading of furniture into your vehicle is a voluntary service.</li>
      <li><strong>Release of Liability:</strong> You release The Beacon House Association of San Pedro from any claims related to loss, damage, or injury during the loading process.</li>
      <li><strong>Assumption of Risks:</strong> You voluntarily assume all risks associated with loading furniture.</li>
      <li><strong>Care and Supervision:</strong> You are responsible for ensuring your vehicle is suitable for loading furniture.</li>
      <li><strong>Indemnification:</strong> You agree to hold harmless The Beacon House Association from any claims arising from the loading service.</li>
      <li><strong>Vehicle Inspection:</strong> Your vehicle was inspected before loading to ensure it is safe and suitable.</li>
      <li><strong>Personal Property:</strong> You are responsible for any personal belongings left in your vehicle.</li>
      <li><strong>Compliance:</strong> You agree to follow all instructions provided by staff during the loading process.</li>
    </ul>
  </div>
</div>
  
  <label>Customer Signature *</label>
  <div class="signature-pad-container">
    <canvas id="signatureCanvas" class="signature-canvas"></canvas>
  </div>
  <div class="signature-controls">
    <button type="button" class="btn btn-secondary" onclick="clearSignature()">Clear Signature</button>
  </div>
  <div class="signature-status" id="signatureStatus"></div>

<!-- Manager Signature (Waiver Only) -->
<div id="managerSignatureSection" style="display: none; margin-top: 30px;">
  <label>Manager Signature *</label>
  <div class="signature-pad-container">
    <canvas id="managerSignatureCanvas" class="signature-canvas"></canvas>
  </div>
  <div class="signature-controls">
    <button type="button" class="btn btn-secondary" onclick="clearManagerSignature()">Clear Manager Signature</button>
  </div>
  <div class="signature-status" id="managerSignatureStatus"></div>
</div>



</div>



        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submitBtn">Save Form</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let currentFormType = 'pickup';
    let allForms = [];
    let isSubmitting = false; // Prevent double submissions
    
    // Signature pad variables
    let canvas, ctx;
    let isDrawing = false;
    let managerCanvas, managerCtx, isManagerDrawing = false;
    let lastX = 0;
    let lastY = 0;

    // Check authentication
    window.onload = function() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/';
        return;
      }
      
      initSignaturePad();
      loadForms();
    };

function initSignaturePad() {
  // Customer signature
  canvas = document.getElementById('signatureCanvas');
  ctx = canvas.getContext('2d');
  
  // Set canvas size properly
  const container = canvas.parentElement;
  canvas.width = container.offsetWidth - 4; // Account for border
  canvas.height = 200;
  
  // Redraw when window resizes
  window.addEventListener('resize', () => {
    const tempImage = ctx.getImageData(0, 0, canvas.width, canvas.height);
    canvas.width = container.offsetWidth - 4;
    canvas.height = 200;
    ctx.putImageData(tempImage, 0, 0);
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
  });
  
  // Set drawing style
  ctx.strokeStyle = '#000';
  ctx.lineWidth = 2;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';

  // Mouse events
  canvas.addEventListener('mousedown', startDrawing);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', stopDrawing);
  canvas.addEventListener('mouseout', stopDrawing);

  // Touch events for mobile
  canvas.addEventListener('touchstart', handleTouchStart);
  canvas.addEventListener('touchmove', handleTouchMove);
  canvas.addEventListener('touchend', stopDrawing);

  // Manager signature (for waiver forms)
  managerCanvas = document.getElementById('managerSignatureCanvas');
  if (managerCanvas) {
    managerCtx = managerCanvas.getContext('2d');
    
    // Set canvas size properly
    const managerContainer = managerCanvas.parentElement;
    managerCanvas.width = managerContainer.offsetWidth - 4;
    managerCanvas.height = 200;
    
    // Set drawing style
    managerCtx.strokeStyle = '#000';
    managerCtx.lineWidth = 2;
    managerCtx.lineCap = 'round';
    managerCtx.lineJoin = 'round';

    // Mouse events
    managerCanvas.addEventListener('mousedown', startManagerDrawing);
    managerCanvas.addEventListener('mousemove', drawManager);
    managerCanvas.addEventListener('mouseup', stopManagerDrawing);
    managerCanvas.addEventListener('mouseout', stopManagerDrawing);

    // Touch events
    managerCanvas.addEventListener('touchstart', handleManagerTouchStart);
    managerCanvas.addEventListener('touchmove', handleManagerTouchMove);
    managerCanvas.addEventListener('touchend', stopManagerDrawing);
  }
}

    function startDrawing(e) {
      isDrawing = true;
      const rect = canvas.getBoundingClientRect();
      lastX = e.clientX - rect.left;
      lastY = e.clientY - rect.top;
    }

    function draw(e) {
      if (!isDrawing) return;
      
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(x, y);
      ctx.stroke();

      lastX = x;
      lastY = y;
    }

    function stopDrawing() {
      isDrawing = false;
    }

    function handleTouchStart(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      lastX = touch.clientX - rect.left;
      lastY = touch.clientY - rect.top;
      isDrawing = true;
    }

    function handleTouchMove(e) {
      if (!isDrawing) return;
      e.preventDefault();
      
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      const x = touch.clientX - rect.left;
      const y = touch.clientY - rect.top;

      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(x, y);
      ctx.stroke();

      lastX = x;
      lastY = y;
    }

    function clearSignature() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

  function isSignatureEmpty() {
  // Check if canvas has valid dimensions
  if (canvas.width === 0 || canvas.height === 0) {
    return true;
  }
  
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  return !imageData.data.some(channel => channel !== 0);
}

// Manager signature functions
function startManagerDrawing(e) {
  isManagerDrawing = true;
  const rect = managerCanvas.getBoundingClientRect();
  lastX = e.clientX - rect.left;
  lastY = e.clientY - rect.top;
}

function drawManager(e) {
  if (!isManagerDrawing) return;
  
  const rect = managerCanvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  managerCtx.beginPath();
  managerCtx.moveTo(lastX, lastY);
  managerCtx.lineTo(x, y);
  managerCtx.stroke();

  lastX = x;
  lastY = y;
}

function stopManagerDrawing() {
  isManagerDrawing = false;
}

function handleManagerTouchStart(e) {
  e.preventDefault();
  const touch = e.touches[0];
  const rect = managerCanvas.getBoundingClientRect();
  lastX = touch.clientX - rect.left;
  lastY = touch.clientY - rect.top;
  isManagerDrawing = true;
}

function handleManagerTouchMove(e) {
  if (!isManagerDrawing) return;
  e.preventDefault();
  
  const touch = e.touches[0];
  const rect = managerCanvas.getBoundingClientRect();
  const x = touch.clientX - rect.left;
  const y = touch.clientY - rect.top;

  managerCtx.beginPath();
  managerCtx.moveTo(lastX, lastY);
  managerCtx.lineTo(x, y);
  managerCtx.stroke();

  lastX = x;
  lastY = y;
}

function clearManagerSignature() {
  managerCtx.clearRect(0, 0, managerCanvas.width, managerCanvas.height);
}

function isManagerSignatureEmpty() {
  // Check if canvas has valid dimensions
  if (managerCanvas.width === 0 || managerCanvas.height === 0) {
    return true;
  }
  
  const imageData = managerCtx.getImageData(0, 0, managerCanvas.width, managerCanvas.height);
  return !imageData.data.some(channel => channel !== 0);
}

function switchFormType(type) {
  currentFormType = type;

  // Update active tab
  document.querySelectorAll('.form-tab').forEach(tab => {
    tab.classList.remove('active');
    if (tab.dataset.type === type) {
      tab.classList.add('active');
    }
  });

  // Update title
  const titles = {
    pickup: 'Pick-Up Forms',
    delivery: 'Delivery Forms',
    donation: 'Donation Forms',
    waiver: 'Waiver Forms'
  };
  document.getElementById('formTitle').textContent = titles[type];

  loadForms();
}

    async function loadForms() {
      const token = localStorage.getItem('token');

      try {
        const response = await fetch(`/api/customer-forms/${currentFormType}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) throw new Error('Failed to load forms');

        const data = await response.json();
        allForms = data.forms;
        displayForms(allForms);
      } catch (error) {
        console.error('Load forms error:', error);
        showMessage('Failed to load forms', 'error');
      }
    }

 function displayForms(forms) {
  const list = document.getElementById('formsList');
  
 if (forms.length === 0) {
  const typeNames = {
    pickup: 'pick-up',
    delivery: 'delivery',
    donation: 'donation',
    waiver: 'waiver'
  };
  list.innerHTML = `
    <div class="empty-state">
      <div class="empty-state-icon">üìã</div>
      <h3>No ${typeNames[currentFormType]} forms yet</h3>
      <p>Click "New Form" to create your first ${typeNames[currentFormType]} form</p>
    </div>
  `;
  return;
}

list.innerHTML = forms.map(form => {
  const descriptionField = currentFormType === 'donation' 
    ? form.donation_description 
    : form.items_description;

  return `
    <div class="form-card ${form.emailed ? 'emailed' : ''}">
      <div class="form-header">
        <div class="form-info">
          <div class="customer-name">${escapeHtml(form.customer_name)}</div>
          <div class="form-meta">
            <span>üìû ${escapeHtml(form.phone)}</span>
            ${form.email ? `<span>üìß ${escapeHtml(form.email)}</span>` : ''}
            <span>üìÖ ${new Date(form.date).toLocaleDateString()}</span>
            ${form.delivery_cost ? `<span>üíµ Delivery: $${parseFloat(form.delivery_cost).toFixed(2)}</span>` : ''}
            ${form.delivery_date ? `<span>üöö Delivery: ${escapeHtml(form.delivery_date)}</span>` : ''}
            <span>${form.emailed ? '<span class="emailed-badge">‚úì Emailed</span>' : '<span class="pending-badge">Pending</span>'}</span>
          </div>
          ${descriptionField && currentFormType !== 'waiver' ? `<div class="form-description">${escapeHtml(descriptionField)}</div>` : ''}
          ${form.signature_url ? `
            <div class="signature-preview">
              <div style="font-size: 12px; color: #718096; margin-bottom: 5px;">Customer Signature:</div>
              <img src="${form.signature_url}" alt="Signature">
            </div>
          ` : ''}
          ${form.manager_signature_url ? `
            <div class="signature-preview">
              <div style="font-size: 12px; color: #718096; margin-bottom: 5px;">Manager Signature:</div>
              <img src="${form.manager_signature_url}" alt="Manager Signature">
            </div>
          ` : ''}
        </div>
        <div>
          <button class="btn btn-danger" onclick="deleteForm(${form.id})">Delete</button>
        </div>
      </div>
    </div>
  `;
}).join('');
}

function openCreateModal() {
  const titles = {
    pickup: 'New Pick-Up Form',
    delivery: 'New Delivery Form',
    donation: 'New Donation Form',
    waiver: 'New Waiver Form'
  };
  
  const descLabels = {
    pickup: 'Items Description',
    delivery: 'Items Description',
    donation: 'Donation Description',
    waiver: 'Items Description'
  };

  document.getElementById('modalTitle').textContent = titles[currentFormType];
  document.getElementById('descriptionLabel').textContent = descLabels[currentFormType];
  document.getElementById('customerForm').reset();
  clearSignature();
  if (typeof clearManagerSignature === 'function') {
    clearManagerSignature();
  }
  
  // Show/hide description field (hide for waiver)
  const descriptionGroup = document.getElementById('descriptionGroup');
  if (currentFormType === 'waiver') {
    descriptionGroup.style.display = 'none';
  } else {
    descriptionGroup.style.display = 'block';
  }
  
  // Show/hide manager signature (only for waiver)
  const managerSignatureSection = document.getElementById('managerSignatureSection');
  if (currentFormType === 'waiver') {
    managerSignatureSection.style.display = 'block';
  } else {
    managerSignatureSection.style.display = 'none';
  }
  
  // Show/hide delivery cost and date fields
  const deliveryCostGroup = document.getElementById('deliveryCostGroup');
  const deliveryCostInput = document.getElementById('delivery_cost');
  const deliveryDateGroup = document.getElementById('deliveryDateGroup');
  
  if (currentFormType === 'delivery') {
    deliveryCostGroup.style.display = 'block';
    deliveryCostInput.required = true;
    deliveryDateGroup.style.display = 'block';
  } else {
    deliveryCostGroup.style.display = 'none';
    deliveryCostInput.required = false;
    deliveryDateGroup.style.display = 'none';
  }
  
  // Show appropriate terms box
  const pickupTermsBox = document.getElementById('pickupTermsBox');
  const deliveryTermsBox = document.getElementById('deliveryTermsBox');
  const waiverTermsBox = document.getElementById('waiverTermsBox');
  
  if (currentFormType === 'pickup') {
    pickupTermsBox.style.display = 'block';
    deliveryTermsBox.style.display = 'none';
    waiverTermsBox.style.display = 'none';
  } else if (currentFormType === 'delivery') {
    pickupTermsBox.style.display = 'none';
    deliveryTermsBox.style.display = 'block';
    waiverTermsBox.style.display = 'none';
  } else if (currentFormType === 'waiver') {
    pickupTermsBox.style.display = 'none';
    deliveryTermsBox.style.display = 'none';
    waiverTermsBox.style.display = 'block';
  } else {
    pickupTermsBox.style.display = 'none';
    deliveryTermsBox.style.display = 'none';
    waiverTermsBox.style.display = 'none';
  }
  
  document.getElementById('formModal').classList.add('active');
  
  // Re-initialize canvas after modal is visible
  setTimeout(() => {
    initSignaturePad();
  }, 100);
}

    function closeModal() {
      document.getElementById('formModal').classList.remove('active');
      document.getElementById('customerForm').reset();
      document.getElementById('signatureStatus').className = 'signature-status';
      document.getElementById('managerSignatureStatus').className = 'signature-status';
      document.getElementById('submitBtn').disabled = false;
      clearSignature();
      isSubmitting = false;
    }

async function handleSubmit(event) {
  event.preventDefault();
  
  // Prevent double submission
  if (isSubmitting) {
    console.log('Form already submitting...');
    return;
  }
  
  const token = localStorage.getItem('token');
  const submitBtn = document.getElementById('submitBtn');
  const signatureStatus = document.getElementById('signatureStatus');
  const managerSignatureStatus = document.getElementById('managerSignatureStatus');
  
  // Disable button and show loading state
  isSubmitting = true;
  submitBtn.disabled = true;
  const originalBtnText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<span class="loading-spinner"></span>Saving...';
  
  const formData = new FormData();

  formData.append('customer_name', document.getElementById('customer_name').value);
  formData.append('phone', document.getElementById('phone').value);
  formData.append('email', document.getElementById('email').value);
  
  // Only add description if not a waiver form
  if (currentFormType !== 'waiver') {
    const description = document.getElementById('description').value;
    if (currentFormType === 'donation') {
      formData.append('donation_description', description);
    } else {
      formData.append('items_description', description);
    }
  }
  
  // Add delivery cost and date if it's a delivery form
  if (currentFormType === 'delivery') {
    const deliveryCost = document.getElementById('delivery_cost').value;
    const deliveryDate = document.getElementById('delivery_date').value;
    formData.append('delivery_cost', deliveryCost);
    formData.append('delivery_date', deliveryDate);
  }

  // Add customer signature if not empty
  if (!isSignatureEmpty()) {
    signatureStatus.textContent = 'Processing signature...';
    signatureStatus.className = 'signature-status active processing';
    
    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
    formData.append('signature', blob, 'signature.png');
  }
  
  // Add manager signature if it's a waiver form and not empty
  if (currentFormType === 'waiver' && !isManagerSignatureEmpty()) {
    managerSignatureStatus.textContent = 'Processing manager signature...';
    managerSignatureStatus.className = 'signature-status active processing';
    
    const managerBlob = await new Promise(resolve => managerCanvas.toBlob(resolve, 'image/png'));
    formData.append('manager_signature', managerBlob, 'manager_signature.png');
  }

  try {
    const response = await fetch(`/api/customer-forms/${currentFormType}`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`
      },
      body: formData
    });

    const data = await response.json();

    if (response.ok) {
      showMessage(data.message, 'success');
      closeModal();
      loadForms();
    } else {
      showMessage(data.error || 'Failed to create form', 'error');
    }
  } catch (error) {
    console.error('Submit error:', error);
    showMessage('Network error. Please try again.', 'error');
  } finally {
    // Re-enable button
    isSubmitting = false;
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalBtnText;
    signatureStatus.className = 'signature-status';
    managerSignatureStatus.className = 'signature-status';
  }
}

    async function deleteForm(formId) {
      if (!confirm('Are you sure you want to delete this form?')) {
        return;
      }

      const token = localStorage.getItem('token');

      try {
        const response = await fetch(`/api/customer-forms/${currentFormType}/${formId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const data = await response.json();

        if (response.ok) {
          showMessage(data.message, 'success');
          loadForms();
        } else {
          showMessage(data.error || 'Delete failed', 'error');
        }
      } catch (error) {
        console.error('Delete error:', error);
        showMessage('Network error. Please try again.', 'error');
      }
    }

    function showMessage(text, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = text;
      messageDiv.className = `message ${type}`;
      messageDiv.style.display = 'block';

      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 5000);
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>